angular.module("miaomiao.shop").factory("ShoppingCart",["$http","$rootScope","localStorageService","$localStorage","$sessionStorage","$timeout","ShopService",function($http,$rootScope,localStorageService,$localStorage,$sessionStorage,$timeout,ShopService){return{_shoppingItems:function(){var shopItems=$sessionStorage.MMMETA_SavedShoppingCartItems||[];return shopItems;},itemExistInCart:function(item,savedItems){for(var idx=0;idx<savedItems.length;idx++){if(item.id==savedItems[idx].id){return true;}}return false;},addItemToCart:function(item){var items=this._shoppingItems();var index=-1;for(var idx=0;idx<items.length;idx++){if(item.id==items[idx].id){index=idx;break;}}if(index==-1){items.push(item);}else{items[index].count=item.count;}$sessionStorage.MMMETA_SavedShoppingCartItems=items;},removeItemFromCart:function(item){var items=this._shoppingItems();var index=-1;for(var idx=0;idx<items.length;idx++){if(item.id==items[idx].id){index=idx;break;}}if(index>-1){if(item.count<=0){items.splice(index,1);}else{items[index].count=item.count;}}$sessionStorage.MMMETA_SavedShoppingCartItems=items;},getAllItems:function(){return this._shoppingItems();},clearAll:function(){$sessionStorage.MMMETA_SavedShoppingCartItems=[];this.itemChangeEventInShoppingCart();},getCountForItem:function(item){var items=this._shoppingItems();for(var idx=0;idx<items.length;idx++){if(item.id==items[idx].id){return items[idx].count;}}return 0;},getCountForCategroy:function(cateId){var items=this._shoppingItems();var total=0;for(var idx=0;idx<items.length;idx++){if(cateId==items[idx].category_id){total+=items[idx].count;}}return total;},getTotalCount:function(){var items=this._shoppingItems();var totalCnt=0;for(var item_idx=0;item_idx<items.length;item_idx++){totalCnt+=parseInt(items[item_idx].count||0);}return totalCnt;},getTotalPrice:function(){var totalPrice=0;var items=this._shoppingItems();for(var item_idx=0;item_idx<items.length;item_idx++){totalPrice+=parseFloat(items[item_idx].price||0)*parseInt(items[item_idx].count||0);}return totalPrice/100;},cartReadyToShip:function(){var shop=ShopService.getDefaultShop()||{},basePrice=shop.base_price||2000;return this.getTotalPrice()>=basePrice/100;},cartNotReadyLeftPrice:function(){var shop=ShopService.getDefaultShop()||{},basePrice=shop.base_price||2000;return Math.round((basePrice/100-this.getTotalPrice())*100)/100;},itemChangeEventInShoppingCart:function(item){$timeout(function(){$rootScope.$broadcast("MMEVENT_ItemSelectionChangedInShoppingCart",{item:item});});},onItemChangeEventInShoppingCart:function($scope,handler){$scope.$on("MMEVENT_ItemSelectionChangedInShoppingCart",function(event,message){handler(message);});},itemChangeEventInProductList:function(item){$timeout(function(){$rootScope.$broadcast("MMEVENT_ItemSelectionChangedInProductList",{item:item});});},onItemChangeEventInProductList:function($scope,handler){$scope.$on("MMEVENT_ItemSelectionChangedInProductList",function(event,message){handler(message);});}};}]);