angular.module("miaomiao.shop").controller("CheckoutCtrl",function(p,l,c,g,b,k,a,f,d,o,h,j,n){p.shoppingCartItems=o.getAllItems();p.shop=f.get("MMMETA_shop");p.info={};p.info.address={};p.info.newOrderAddress="";p.info.newOrderPhone="";function e(){p.info.remarks="";p.LoadingMessage="正在核对,请稍候...";g.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:p});d.getConfirmCartList(p.shop.id,o.getAllItems(),function(w,q){g.hide();var u=w.code,v=w.data;if(u==500){b.alert({title:"加载数据失败:"+w.msg,template:""});return;}else{if(u==100){b.alert({title:"部分商品不足，请谨慎购买:"+w.msg,template:""});}}p.shop=v.shop;for(var s=0;s<v.itemls.length;s++){var t=v.itemls[s];for(var r=0;r<p.shoppingCartItems.length;r++){if(t.id==p.shoppingCartItems[r].id){if(t.info){p.shoppingCartItems[r].message=t.info;}}}}p.addressls=v.addressls;p.info.address=p.addressls&&p.addressls.length&&p.addressls[0];if(!p.info.address){p.info.showAddNewAddress=true;}},function(r,q){g.hide();});}p.goToAddressList=function(){a.go("addressList",null,{reload:true});};p.goback=function(){a.go("productList",null,{reload:true});};p.cartReadyToShip=o.cartReadyToShip();p.selectItem=function(q){q.count+=1;o.itemChangeEventInShoppingCart(q);i();};p.removeItem=function(r,q){r.count-=1;if(r.count<=0){r.count=0;o.removeItemFromCart(r);}o.itemChangeEventInShoppingCart(r);i();};p.confirmCheckout=function(){if(!p.cartReadyToShip){return;}if(p.addressls&&p.addressls.length){p.info.address=p.addressls[0];}else{p.info.address={id:"",address:p.info.newOrderAddress,phone:p.info.newOrderPhone};if(!p.info.newOrderAddress||!p.info.newOrderPhone||!n.isValidTelNumber(p.info.newOrderPhone)){b.alert({title:"请填写正确的地址电话",template:""});return;}p.addressls=p.addressls||[];p.addressls[0]=p.info.address;p.info.showAddNewAddress=false;}p.LoadingMessage="正在生成订单,请稍候...";g.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:p});d.getOrderSave(p.shop.id,p.info.address.id,p.info.address.address,p.info.address.phone,p.info.remarks||"",p.shoppingCartItems,p.info.order_id,function(t,q){g.hide();var r=t.code,s=t.data;if(r==500){b.alert({title:"生成订单失败，请重新购买:"+t.msg,template:""});return;}else{if(r==100){b.alert({title:"部分商品不足，请重新购买:"+t.msg,template:""});return;}}o.clearAll();i();a.go("myOrders",null,{reload:true});},function(r,q){g.hide();b.alert({title:"生成订单失败，请重新购买:"+r.msg,template:""});});};function m(q){if(q){p.addressls=p.addressls||[];p.addressls[0]=q;p.info.address=p.addressls[0];}else{p.LoadingMessage="正在更新地址...";g.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:p});d.getAddressList(p.shop.id,function(u,r){var s=u.code,t=u.data;if(s!=0){b.alert({title:"加载数据失败:"+u.msg,template:""});return;}g.hide();p.addressls=t.addressls||[];},function(s,r){p.addressls=[];b.alert({title:"加载数据失败,请重试",template:""});});}}function i(){c(function(){p.shoppingCartItems=o.getAllItems();p.cartReadyToShip=o.cartReadyToShip();p.checkoutHintMessage=p.cartReadyToShip?"货到付款":"差 "+o.cartNotReadyLeftPrice()+" 元起送";});}h.onAddressChangeEventSwitchDefault(p,function(q){m(q.item);});h.onAddressChangeEventAddNew(p,function(q){m(q.item);});j.onOrderChangeEventSuccess(p,function(){i();});p.$on("$ionicView.enter",function(){i();e();});});