angular.module("miaomiao.shop").controller("SearchCtrl",function(l,j,g,d,b,i,a,c,f,e,k){l.shop=f.get("MMMETA_shop")||{};l.info={};l.performSearch=function(o,n){n.target.blur();var m=o||l.info.key;l.LoadingMessage="正在搜索...";g.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:l});l.info.showSearchSuggestion=false;l.info.showSearchResult=true;e.getSearchResults(l.shop.id,m,function(t,p){g.hide();var r=t.code,s=t.data;if(!r==0||s.length==0){l.searchResultsItems=[];l.info.hasNoResults=true;return;}l.info.hasNoResults=false;for(var u=0;u<s.length;u++){var q=s[u];q.count=k.getCountForItem(q);}l.searchResultsItems=s;d.$getByHandle("searchResultScroll").scrollTop();},function(q,p){g.hide();l.info.hasNoResults=true;});};l.getSearchSuggestions=function(){e.getSearchSuggestion(l.shop.id,l.info.key,function(p,m){var n=p.code,o=p.data;c(function(){l.info.search_suggestions=o;});},function(n,m){});};l.goToSearchItem=function(n,m){l.info.showSearchSuggestion=false;l.info.showSearchResult=true;m.stopPropagation();l.performSearch(n.key,m);};function h(){c(function(){l.info.shoppingCartItems=k.getAllItems();l.info.cartReadyToShip=k.cartReadyToShip();l.info.checkoutHintMessage=l.info.cartReadyToShip?"去结算":"差 "+k.cartNotReadyLeftPrice()+" 元起送";});}h();l.selectItem=function(m){m.count+=1;k.addItemToCart(m);h();k.itemChangeEventInProductList(m);};l.removeItem=function(n,m){n.count-=1;n.count=n.count<=0?0:n.count;k.removeItemFromCart(n);h();k.itemChangeEventInProductList(n);};l.startSearch=function(){l.info.showSearchSuggestion=true;l.info.showSearchResult=false;};l.clearSearch=function(){l.info.key="";l.info.showSearchSuggestion=true;l.info.showSearchResult=false;};l.checkout=function(){a.go("checkout",null,{reload:true});};l.showShoppingCart=function(){l.info.showCart=!l.info.showCart;};k.onItemChangeEventInShoppingCart(l,function(n){var m=n.item;h();for(var o=0;o<l.searchResultsItems.length;o++){var m=l.searchResultsItems[o];m.count=k.getCountForItem(m);}});});