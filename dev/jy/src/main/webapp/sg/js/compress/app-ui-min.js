angular.module("miaomiao.shop",["ionic","LocalStorageModule","ngStorage","ngAnimate","pasvaz.bindonce","QuickList"]).config(function($httpProvider,$provide){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var param=function(obj){var query="",name,value,fullSubName,subName,subValue,innerObj,i;for(name in obj){value=obj[name];if(value instanceof Array){for(i=0;i<value.length;++i){subValue=value[i];fullSubName=name+"["+i+"]";innerObj={};innerObj[fullSubName]=subValue;query+=param(innerObj)+"&";}}else{if(value instanceof Object){for(subName in value){subValue=value[subName];fullSubName=name+"["+subName+"]";innerObj={};innerObj[fullSubName]=subValue;query+=param(innerObj)+"&";}}else{if(value!==undefined&&value!==null){query+=encodeURIComponent(name)+"="+encodeURIComponent(value)+"&";}}}}return query.length?query.substr(0,query.length-1):query;};$httpProvider.defaults.transformRequest=[function(data){return angular.isObject(data)&&String(data)!=="[object File]"?param(data):data;}];}).config(function($stateProvider,$urlRouterProvider,$ionicConfigProvider){$ionicConfigProvider.tabs.position("bottom");$ionicConfigProvider.tabs.style("standard");$stateProvider.state("locate",{url:"/locate",templateUrl:"templates/locate.html",controller:"LoadingCtrl"}).state("findshop",{url:"/findshop",templateUrl:"templates/findShop.html",controller:"FindShopCtrl"}).state("productList",{url:"/productlist",templateUrl:"templates/productList.html",controller:"ProductCtrl"}).state("goToShop",{url:"/shop?shop_id",templateUrl:"templates/productList.html",controller:"GoToShopCtrl"}).state("search",{url:"/search",templateUrl:"templates/searchProduct.html",controller:"SearchCtrl"}).state("checkout",{url:"/checkout",templateUrl:"templates/checkoutOrder.html",controller:"CheckoutCtrl"}).state("addressList",{url:"/addresslist",templateUrl:"templates/addressList.html",controller:"AddressListCtrl"}).state("userAddressList",{url:"/useraddresslist",templateUrl:"templates/addressList.html",controller:"UserAddressListCtrl"}).state("myOrders",{url:"/myorders",templateUrl:"templates/myOrders.html",controller:"MyOrdersCtrl"});$urlRouterProvider.otherwise("/locate");}).config(function($provide){$provide.decorator("$state",function($delegate,$stateParams){$delegate.forceReload=function(){return $delegate.go($delegate.current,$stateParams,{reload:true,inherit:false,notify:true});};return $delegate;});});angular.module("miaomiao.shop").directive("backImg",function(){return function(scope,element,attrs){var url=attrs.backImg;element.css({"background-image":"url("+url+")","background-size":"contain"});};}).directive("slideable",function(){return{restrict:"C",compile:function(element,attr){var contents=element.html();element.html('<div class="slideable_content" style="margin:0 !important; padding:0 !important" >'+contents+"</div>");return function postLink(scope,element,attrs){attrs.duration=(!attrs.duration)?"1s":attrs.duration;attrs.easing=(!attrs.easing)?"ease-in-out":attrs.easing;element.css({overflow:"hidden",display:"none",transitionProperty:"height",transitionDuration:attrs.duration,transitionTimingFunction:attrs.easing});};}};}).directive("slideToggle",function(){return{restrict:"A",scope:{isOpen:"=slideToggle"},link:function(scope,element,attr){var slideDuration=parseInt(attr.slideToggleDuration,10)||200;scope.$watch("isOpen",function(newIsOpenVal,oldIsOpenVal){if(newIsOpenVal!==oldIsOpenVal){element.stop().slideToggle(slideDuration);}});}};}).directive("bnSlideShow",function(){function link($scope,element,attributes){var expression=attributes.bnSlideShow;var duration=(attributes.slideShowDuration||"fast");if(!$scope.$eval(expression)){$(element).hide();}$scope.$watch(expression,function(newValue,oldValue){if(newValue===oldValue){return;}if(newValue){$(element).stop(true,true).slideDown(duration);}else{$(element).stop(true,true).slideUp(duration);}});}return({link:link,restrict:"A"});}).directive("bnCommonShow",function(){function link($scope,element,attributes){var expression=attributes.bnCommonShow;if(!$scope.$eval(expression)){$(element).hide();}$scope.$watch(expression,function(newValue,oldValue){if(newValue===oldValue){return;}if(newValue){$(element).show();}else{$(element).hide();}});}return({link:link,restrict:"A"});});angular.module("miaomiao.shop").filter("getTotolCount",function(){return function(input){input=input||[];var total=0;for(var item_idx=0;item_idx<input.length;item_idx++){total+=parseInt(input[item_idx].count||0);}return total;};}).filter("getTotolPrice",function(){return function(input){input=input||[];var total=0;for(var item_idx=0;item_idx<input.length;item_idx++){total+=parseFloat(input[item_idx].price||0)*parseInt(input[item_idx].count||0);}return total/100;};}).filter("removeAMPM",function(){return function(text){if(!text){return;}return text.replace(/AM/,"").replace(/PM/,"");};}).filter("getShopStatusString",function(){return function(input){return input==0?"营业中":"打烊了";};}).filter("getShopMinPrice",function(){return function(input){return input?input/100:20;};}).filter("insertSpaceForShortName",function(){return function(input){return input.length==2?input.charAt(0)+"    "+input.charAt(1):input;};}).filter("parseIntDistant",function(){return function(input){return parseInt(input);};});angular.module("miaomiao.shop").factory("httpClient",["$http",function($http){var doGet=function(path,params,success,fail){$http({method:"GET",url:path+"?"+params}).success(function(data,status,headers,config){success(data,status,headers,config);}).error(function(data,status,headers,config){fail(data,status,headers,config);});};var doPost=function(path,params,success,fail){$http.post(path,params,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).success(function(data,status,headers,config){success(data,status,headers,config);}).error(function(data,status,headers,config){fail(data,status,headers,config);});};return{getProductList:function(shopId,success,fail){doGet("shop/category/get","shop_id="+shopId,success,fail);},getMoreProductList:function(shopId,cateId,from,offset,success,fail){doGet("shop/getitems","shop_id="+shopId+"&category_id="+cateId+"&from="+from+"&offset="+offset,success,fail);},getAddressList:function(shopId,success,fail){doGet("address","shop_id="+shopId,success,fail);},setDefaultAddress:function(shopId,addr,success,fail){doPost("address/default?shop_id="+shopId,{address_id:addr.id,address:addr.address,phone:addr.phone},success,fail);},addAddress:function(shopId,addr,success,fail){doPost("address/add?shop_id="+shopId,{address:addr.address,phone:addr.phone},success,fail);},getConfirmCartList:function(shopId,items,success,fail){doPost("shopCar/confirm?shop_id="+shopId,{items:JSON.stringify(items)},success,fail);},getOrderSave:function(shopId,addressId,address,phone,remarks,items,orderId,success,fail){doPost("order/save?shop_id="+shopId,{items:JSON.stringify(items),address_id:addressId,address:address,phone:phone,remarks:remarks,order_id:orderId},success,fail);},getOrderPrepayInfo:function(shopId,addressId,address,phone,remarks,items,orderId,success,fail){doPost("order/save?shop_id="+shopId,{items:JSON.stringify(items),address_id:addressId,address:address,phone:phone,remarks:remarks,order_id:orderId,act:"wx"},success,fail);},updateOrderStatus:function(shopId,orderId,msg,success,fail){doPost("order/pay_cb?shop_id="+shopId,{order_id:orderId,msg:msg},success,fail);},getJsapi_ticket:function(success,fail){doGet("/wx/wxpay/getjtk","",success,fail);},getPageConfig:function(url,success,fail){doGet("/wx/wxpay/getConfig","url="+url,success,fail);},getHashFromServer:function(string,signType,success,fail){doGet("/wx/wxpay/getHash","package="+string+"&signType="+signType,success,fail);},getMyOrders:function(shopId,success,fail){doGet("user/profile","shop_id="+shopId,success,fail);},getSearchResults:function(shopId,key,success,fail){doGet("search/query","shop_id="+shopId+"&key="+key,success,fail);},getSearchSuggestion:function(shopId,key,success,fail){doGet("/suggestion/query","shop_id="+shopId+"&q="+key,success,fail);},getShopByGEOLocation:function(lat,lng,success,fail){doGet("f","lat="+lat+"&lng="+lng,success,fail);},getShopList:function(from,offset,success,fail){doGet("shop/shopList","from="+from+"&offset="+offset,success,fail);},getShopInfo:function(shop_id,success,fail){doGet("shop","shop_id="+shop_id,success,fail);},getDefaultShopInfo:function(success,fail){doGet("storage/get","",success,fail);},setDefaultShopInfo:function(shop_id,success,fail){doGet("storage/set","shop_id="+shop_id,success,fail);},getNearShopList:function(lat,lng,success,fail){doGet("near","lat="+lat+"&lng="+lng,success,fail);},getNearCommunityList:function(lat,lng,success,fail){doGet("commy/near","lat="+lat+"&lng="+lng,success,fail);},getShopsByCommunityId:function(c_id,success,fail){doGet("commy/getshop","c_id="+c_id,success,fail);},getCommunitySuggestions:function(query,success,fail){doGet("commy/query","q="+query,success,fail);},getCommunityByName:function(query,success,fail){doGet("commy/search","key="+query,success,fail);}};}]).factory("GEOLocationService",["$timeout",function($timeout){return{GEOLocationSupported:function(obj){return navigator.geolocation;}};}]).factory("AddressService",["$http","$rootScope","$timeout",function($http,$rootScope,$timeout){return{addressChangeEventSwitchDefault:function(item){$timeout(function(){$rootScope.$broadcast("MMEVENT_AddressChangeEventSwitchDefault",{item:item});});},onAddressChangeEventSwitchDefault:function($scope,handler){$scope.$on("MMEVENT_AddressChangeEventSwitchDefault",function(event,message){handler(message);});},addressChangeEventAddNew:function(item){$timeout(function(){$rootScope.$broadcast("MMEVENT_AddressChangeEventAddNew",{item:item});});},onAddressChangeEventAddNew:function($scope,handler){$scope.$on("MMEVENT_AddressChangeEventAddNew",function(event,message){handler(message);});}};}]).factory("OrderService",["$http","$rootScope","$timeout",function($http,$rootScope,$timeout){return{orderChangeEventSuccess:function(item){$timeout(function(){$rootScope.$broadcast("MMEVENT_OrderChangeEventSuccess",{item:item});});},onOrderChangeEventSuccess:function($scope,handler){$scope.$on("MMEVENT_OrderChangeEventSuccess",function(event,message){handler(message);});}};}]).factory("ShopService",["$http","$rootScope","$timeout","httpClient","localStorageService",function($http,$rootScope,$timeout,httpClient,localStorageService){var _defaultShop=null;return{setDefaultShop:function(shop){_defaultShop=shop;localStorageService.set("MMMETA_shop",shop);},setDefaultShopAndSync:function(shop){_defaultShop=shop;localStorageService.set("MMMETA_shop",shop);this.setDefaultShopToServer(shop.id,function(){},function(){});},getDefaultShop:function(){return _defaultShop||localStorageService.get("MMMETA_shop");},getDefaultShopFromServer:function(success,fail){var self=this;httpClient.getDefaultShopInfo(function(data,status){var code=data.code,dataDetail=data.data;if(code==0&&dataDetail&&dataDetail.shop){self.setDefaultShop(dataDetail.shop);return success(dataDetail.shop);}return fail(null);},function(data,status){fail(null);});},setDefaultShopToServer:function(shop_id,success,fail){httpClient.setDefaultShopInfo(shop_id,function(data,status){var code=data.code,dataDetail=data.data;if(code==0){success();return;}fail(null);},function(data,status){fail(null);});}};}]).factory("MMUtils",["$timeout","$ionicLoading","$ionicPopup",function($timeout,$ionicLoading,$ionicPopup){function rstr2hex(input){try{hexcase;}catch(e){hexcase=0;}var hex_tab=hexcase?"0123456789ABCDEF":"0123456789abcdef";var output="";var x;for(var i=0;i<input.length;i++){x=input.charCodeAt(i);output+=hex_tab.charAt((x>>>4)&15)+hex_tab.charAt(x&15);}return output;}function rstr2binl(input){var output=Array(input.length>>2);for(var i=0;i<output.length;i++){output[i]=0;}for(var i=0;i<input.length*8;i+=8){output[i>>5]|=(input.charCodeAt(i/8)&255)<<(i%32);}return output;}function binl_md5(x,len){x[len>>5]|=128<<((len)%32);x[(((len+64)>>>9)<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;a=md5_ff(a,b,c,d,x[i+0],7,-680876936);d=md5_ff(d,a,b,c,x[i+1],12,-389564586);c=md5_ff(c,d,a,b,x[i+2],17,606105819);b=md5_ff(b,c,d,a,x[i+3],22,-1044525330);a=md5_ff(a,b,c,d,x[i+4],7,-176418897);d=md5_ff(d,a,b,c,x[i+5],12,1200080426);c=md5_ff(c,d,a,b,x[i+6],17,-1473231341);b=md5_ff(b,c,d,a,x[i+7],22,-45705983);a=md5_ff(a,b,c,d,x[i+8],7,1770035416);d=md5_ff(d,a,b,c,x[i+9],12,-1958414417);c=md5_ff(c,d,a,b,x[i+10],17,-42063);b=md5_ff(b,c,d,a,x[i+11],22,-1990404162);a=md5_ff(a,b,c,d,x[i+12],7,1804603682);d=md5_ff(d,a,b,c,x[i+13],12,-40341101);c=md5_ff(c,d,a,b,x[i+14],17,-1502002290);b=md5_ff(b,c,d,a,x[i+15],22,1236535329);a=md5_gg(a,b,c,d,x[i+1],5,-165796510);d=md5_gg(d,a,b,c,x[i+6],9,-1069501632);c=md5_gg(c,d,a,b,x[i+11],14,643717713);b=md5_gg(b,c,d,a,x[i+0],20,-373897302);a=md5_gg(a,b,c,d,x[i+5],5,-701558691);d=md5_gg(d,a,b,c,x[i+10],9,38016083);c=md5_gg(c,d,a,b,x[i+15],14,-660478335);b=md5_gg(b,c,d,a,x[i+4],20,-405537848);a=md5_gg(a,b,c,d,x[i+9],5,568446438);d=md5_gg(d,a,b,c,x[i+14],9,-1019803690);c=md5_gg(c,d,a,b,x[i+3],14,-187363961);b=md5_gg(b,c,d,a,x[i+8],20,1163531501);a=md5_gg(a,b,c,d,x[i+13],5,-1444681467);d=md5_gg(d,a,b,c,x[i+2],9,-51403784);c=md5_gg(c,d,a,b,x[i+7],14,1735328473);b=md5_gg(b,c,d,a,x[i+12],20,-1926607734);a=md5_hh(a,b,c,d,x[i+5],4,-378558);d=md5_hh(d,a,b,c,x[i+8],11,-2022574463);c=md5_hh(c,d,a,b,x[i+11],16,1839030562);b=md5_hh(b,c,d,a,x[i+14],23,-35309556);a=md5_hh(a,b,c,d,x[i+1],4,-1530992060);d=md5_hh(d,a,b,c,x[i+4],11,1272893353);c=md5_hh(c,d,a,b,x[i+7],16,-155497632);b=md5_hh(b,c,d,a,x[i+10],23,-1094730640);a=md5_hh(a,b,c,d,x[i+13],4,681279174);d=md5_hh(d,a,b,c,x[i+0],11,-358537222);c=md5_hh(c,d,a,b,x[i+3],16,-722521979);b=md5_hh(b,c,d,a,x[i+6],23,76029189);a=md5_hh(a,b,c,d,x[i+9],4,-640364487);d=md5_hh(d,a,b,c,x[i+12],11,-421815835);c=md5_hh(c,d,a,b,x[i+15],16,530742520);b=md5_hh(b,c,d,a,x[i+2],23,-995338651);a=md5_ii(a,b,c,d,x[i+0],6,-198630844);d=md5_ii(d,a,b,c,x[i+7],10,1126891415);c=md5_ii(c,d,a,b,x[i+14],15,-1416354905);b=md5_ii(b,c,d,a,x[i+5],21,-57434055);a=md5_ii(a,b,c,d,x[i+12],6,1700485571);d=md5_ii(d,a,b,c,x[i+3],10,-1894986606);c=md5_ii(c,d,a,b,x[i+10],15,-1051523);b=md5_ii(b,c,d,a,x[i+1],21,-2054922799);a=md5_ii(a,b,c,d,x[i+8],6,1873313359);d=md5_ii(d,a,b,c,x[i+15],10,-30611744);c=md5_ii(c,d,a,b,x[i+6],15,-1560198380);b=md5_ii(b,c,d,a,x[i+13],21,1309151649);a=md5_ii(a,b,c,d,x[i+4],6,-145523070);d=md5_ii(d,a,b,c,x[i+11],10,-1120210379);c=md5_ii(c,d,a,b,x[i+2],15,718787259);b=md5_ii(b,c,d,a,x[i+9],21,-343485551);a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd);}return Array(a,b,c,d);}function md5_cmn(q,a,b,x,s,t){return safe_add(bit_rol(safe_add(safe_add(a,q),safe_add(x,t)),s),b);}function md5_ff(a,b,c,d,x,s,t){return md5_cmn((b&c)|((~b)&d),a,b,x,s,t);}function md5_gg(a,b,c,d,x,s,t){return md5_cmn((b&d)|(c&(~d)),a,b,x,s,t);}function md5_hh(a,b,c,d,x,s,t){return md5_cmn(b^c^d,a,b,x,s,t);}function md5_ii(a,b,c,d,x,s,t){return md5_cmn(c^(b|(~d)),a,b,x,s,t);}function safe_add(x,y){var lsw=(x&65535)+(y&65535);var msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&65535);}function bit_rol(num,cnt){return(num<<cnt)|(num>>>(32-cnt));}function binl2rstr(input){var output="";for(var i=0;i<input.length*32;i+=8){output+=String.fromCharCode((input[i>>5]>>>(i%32))&255);}return output;}function rstr_md5(s){return binl2rstr(binl_md5(rstr2binl(s),s.length*8));}function str2rstr_utf8(input){var output="";var i=-1;var x,y;while(++i<input.length){x=input.charCodeAt(i);y=i+1<input.length?input.charCodeAt(i+1):0;if(55296<=x&&x<=56319&&56320<=y&&y<=57343){x=65536+((x&1023)<<10)+(y&1023);i++;}if(x<=127){output+=String.fromCharCode(x);}else{if(x<=2047){output+=String.fromCharCode(192|((x>>>6)&31),128|(x&63));}else{if(x<=65535){output+=String.fromCharCode(224|((x>>>12)&15),128|((x>>>6)&63),128|(x&63));}else{if(x<=2097151){output+=String.fromCharCode(240|((x>>>18)&7),128|((x>>>12)&63),128|((x>>>6)&63),128|(x&63));}}}}}return output;}return{isEmptyObject:function(obj){if(obj==null){return true;}if(obj.length>0){return false;}if(obj.length===0){return true;}for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){return false;}}return true;},isValidTelNumber:function(number){var regPhone=/^(([0\+]\d{2,3}-)?(0\d{2,3})-)?(\d{7,8})(-(\d{3,}))?$/;var regMobile=/^1[3|4|5|6|7|8|9][0-9]{1}[0-9]{8}$/;return regPhone.test(number)||regMobile.test(number);},showLoadingIndicator:function(message,scope,tmpUrl){scope.LoadingMessage=message;$ionicLoading.show({templateUrl:tmpUrl||"templates/loadingIndicator.html",scope:scope});},showAlert:function(message,tmpUrl){$ionicPopup.alert({title:message,template:tmpUrl||""});},hex_md5:function(s){return rstr2hex(rstr_md5(str2rstr_utf8(s)));}};}]);angular.module("miaomiao.shop").factory("ShoppingCart",["$http","$rootScope","localStorageService","$localStorage","$sessionStorage","$timeout","ShopService",function($http,$rootScope,localStorageService,$localStorage,$sessionStorage,$timeout,ShopService){return{_shoppingItems:function(){var shopItems=$sessionStorage.MMMETA_SavedShoppingCartItems||[];return shopItems;},itemExistInCart:function(item,savedItems){for(var idx=0;idx<savedItems.length;idx++){if(item.id==savedItems[idx].id){return true;}}return false;},addItemToCart:function(item){var items=this._shoppingItems();var index=-1;for(var idx=0;idx<items.length;idx++){if(item.id==items[idx].id){index=idx;break;}}if(index==-1){items.push(item);}else{items[index].count=item.count;}$sessionStorage.MMMETA_SavedShoppingCartItems=items;},removeItemFromCart:function(item){var items=this._shoppingItems();var index=-1;for(var idx=0;idx<items.length;idx++){if(item.id==items[idx].id){index=idx;break;}}if(index>-1){if(item.count<=0){items.splice(index,1);}else{items[index].count=item.count;}}$sessionStorage.MMMETA_SavedShoppingCartItems=items;},getAllItems:function(){return this._shoppingItems();},clearAll:function(){$sessionStorage.MMMETA_SavedShoppingCartItems=[];this.itemChangeEventInShoppingCart();},getCountForItem:function(item){var items=this._shoppingItems();for(var idx=0;idx<items.length;idx++){if(item.id==items[idx].id){return items[idx].count;}}return 0;},getCountForCategroy:function(cateId){var items=this._shoppingItems();var total=0;for(var idx=0;idx<items.length;idx++){if(cateId==items[idx].category_id){total+=items[idx].count;}}return total;},getTotalCount:function(){var items=this._shoppingItems();var totalCnt=0;for(var item_idx=0;item_idx<items.length;item_idx++){totalCnt+=parseInt(items[item_idx].count||0);}return totalCnt;},getTotalPrice:function(){var totalPrice=0;var items=this._shoppingItems();for(var item_idx=0;item_idx<items.length;item_idx++){totalPrice+=parseFloat(items[item_idx].price||0)*parseInt(items[item_idx].count||0);}return totalPrice/100;},cartReadyToShip:function(){var shop=ShopService.getDefaultShop()||{},basePrice=shop.base_price||2000;return this.getTotalPrice()>=basePrice/100;},cartNotReadyLeftPrice:function(){var shop=ShopService.getDefaultShop()||{},basePrice=shop.base_price||2000;return Math.round((basePrice/100-this.getTotalPrice())*100)/100;},itemChangeEventInShoppingCart:function(item){$timeout(function(){$rootScope.$broadcast("MMEVENT_ItemSelectionChangedInShoppingCart",{item:item});});},onItemChangeEventInShoppingCart:function($scope,handler){$scope.$on("MMEVENT_ItemSelectionChangedInShoppingCart",function(event,message){handler(message);});},itemChangeEventInProductList:function(item){$timeout(function(){$rootScope.$broadcast("MMEVENT_ItemSelectionChangedInProductList",{item:item});});},onItemChangeEventInProductList:function($scope,handler){$scope.$on("MMEVENT_ItemSelectionChangedInProductList",function(event,message){handler(message);});}};}]);angular.module("miaomiao.shop").factory("WeiChatPay",function($http,MMUtils,httpClient){if(!wx){console.log("Error微信js-sdk 没有加载");return;}var hasBeenInit=false;var weiChatPayUtils={},wechatConfig={appId:"wx762f832959951212",mch_id:"1233699402",appsecret:"914f4388312ca90e4cb750b817d15368"};weiChatPayUtils.getNonceStr=function(){return Math.random().toString(36).substr(2,15);};weiChatPayUtils.getHashCondidate=function(params){var objKeys=Object.keys(params);objKeys=objKeys.sort();var str="";for(var i=0;i<objKeys.length;i++){str+=objKeys[i].toLowerCase()+"="+params[objKeys[i]]+"&";}var stringSignTemp=str+"key="+wechatConfig.appsecret;return stringSignTemp;};weiChatPayUtils.getHash=function(params){var objKeys=Object.keys(params);objKeys=objKeys.sort();var str="";for(var i=0;i<objKeys.length;i++){str+=objKeys[i].toLowerCase()+"="+params[objKeys[i]]+"&";}var stringSignTemp=str+"key="+wechatConfig.appsecret;return MMUtils.hex_md5(stringSignTemp).toUpperCase();};weiChatPayUtils.getTimestamp=function(){return parseInt(new Date().getTime()/1000)+"";};if(!hasBeenInit){var config={debug:true,appId:wechatConfig.appId,jsApiList:["chooseWXPay"]};httpClient.getPageConfig(window.location.href.split("#")[0],function(data,status){if(data&&data.data){var detail=data.data;config.signature=detail.signature.toUpperCase();config.nonceStr=detail.nonceStr;config.timestamp=detail.timestamp;wx.config(config);}},function(){});wx.error(function(res){});wx.ready(function(){weiChatPayUtils.checkPayAPI=function(success,fail){wx.checkJsApi({jsApiList:["chooseWXPay"],success:function(res){if(res.checkResult.chooseWXPay){success();}else{fail();}},fail:function(){fail();}});};weiChatPayUtils.chooseWXPay=function(info,beforeHandoverToWCPay,success,fail){var pkg="";for(var p in info){pkg+=p+"="+info[p]+"&";}pkg=pkg.slice(0,-1);var info={signType:"SHA1","package":pkg};function onHashReady(){info.success=function(res){if(res.err_msg=="get_brand_wcpay_request:ok"){success(res);}else{fail(res);}};if(beforeHandoverToWCPay){beforeHandoverToWCPay();}wx.chooseWXPay(info);}httpClient.getHashFromServer(info["package"],info.signType,function(data,status){var detail=data.data;info.paySign=detail.signature.toUpperCase();info.nonceStr=detail.nonceStr;info.timestamp=detail.timestamp;onHashReady();},function(data,status){fail();});};});hasBeenInit=true;}return weiChatPayUtils;});angular.module("miaomiao.shop").controller("LoadingCtrl",function($scope,$ionicLoading,$http,$state,localStorageService,$timeout,ShopService,httpClient,MMUtils,WeiChatPay){$scope.info={};$scope.info.showLocateImg=true;function showPosition(position){if(position){$scope.info.getGeolocationTitle="定位成功，正在加载请稍候...";$scope.info.getGeolocationTitleClass="getGeolocation-title-success";localStorageService.set("MMMETA_location_pos_ready",1);localStorageService.set("MMMETA_location_pos_data",{lat:position.coords.latitude,lng:position.coords.longitude});$state.go("findshop");}else{$scope.info.getGeolocationTitle="定位失败...";localStorageService.set("MMMETA_location_pos_ready",0);$state.go("findshop");}}function showError(error){$scope.info.getGeolocationTitleClass="getGeolocation-title-fail";switch(error.code){case error.PERMISSION_DENIED:$scope.info.getGeolocationTitle="定位失败，请确认您开启位置服务";break;case error.POSITION_UNAVAILABLE:$scope.info.getGeolocationTitle="定位失败，请确认您开启位置服务";break;case error.TIMEOUT:$scope.info.getGeolocationTitle="定位超时，请您重试";break;case error.UNKNOWN_ERROR:$scope.info.getGeolocationTitle="定位出现未知错误，请您重试";break;default:$scope.info.getGeolocationTitle="定位失败，请您重试";}localStorageService.set("MMMETA_location_pos_ready",0);$state.go("findshop");}function getLocation(){if(navigator.geolocation){var position_option={enableHighAccuracy:true,timeout:10000};navigator.geolocation.getCurrentPosition(showPosition,showError,position_option);}else{$scope.info.showLocateImg=false;$scope.info.getGeolocationTitle="您的浏览器不支持定位！";localStorageService.set("MMMETA_location_pos_ready",0);$state.go("findshop");}}$scope.$on("$ionicView.afterEnter",function(){$scope.info.getGeolocationTitle="定位中...";$scope.info.getGeolocationTitleClass="blink_me";$scope.info.hasDefaultShop=false;ShopService.getDefaultShopFromServer(function(shop){$scope.info.hasDefaultShop=true;ShopService.setDefaultShop(shop);$state.go("productList");},function(){var localDefaultShop=localStorageService.get("MMMETA_shop");if(localDefaultShop&&localDefaultShop.id){$scope.info.hasDefaultShop=true;ShopService.setDefaultShopAndSync(localDefaultShop);$state.go("productList");}else{$scope.info.hasDefaultShop=false;$timeout(function(){getLocation();},500);}});});});angular.module("miaomiao.shop").controller("FindShopCtrl",function($scope,$http,$state,$location,$ionicLoading,$ionicScrollDelegate,localStorageService,httpClient,ShopService,MMUtils,$timeout){$scope.shop_data={};$scope.shop_items=[];$scope.shop_info={};$scope.shop_info.locationReady=localStorageService.get("MMMETA_location_pos_ready");if(!$scope.shop_info.locationReady){$scope.shop_info.locationMessage="定位失败,您可以搜索所在的小区";}else{if(localStorageService.get("MMMETA_location_pos_addr")){$scope.shop_info.locationMessage=localStorageService.get("MMMETA_location_pos_addr");}else{$scope.shop_info.locationMessage="点击重新定位";}}$scope.searchButtonText="搜索";$scope.shop_history=localStorageService.get("MMMETA_shop_history")||[];$scope.clearSearch=function(){$scope.shop_data.searchQuery="";hideSearchSuggestions();};function showSearchSuggestions(){$scope.shop_info.showAddressSuggestion=true;}function hideSearchSuggestions(){$scope.shop_info.showAddressSuggestion=false;}$scope.startSearch=function(){if($scope.shop_data.searchQuery&&$scope.shop_data.searchQuery.length>0){$scope.searchButtonText="搜索";}else{$scope.searchButtonText="取消";}showSearchSuggestions();};$scope.goToShop=function(shop){if(shop.status!=undefined&&shop.status!=0){MMUtils.showAlert("您选择的小区店铺已经打烊了");return;}var shopExist=false;for(var i=0;i<$scope.shop_history.length;i++){if(shop.id==$scope.shop_history[i].id){shopExist=true;break;}}if(!shopExist){$scope.shop_history.push(shop);}localStorageService.set("MMMETA_shop_history",$scope.shop_history);ShopService.setDefaultShopAndSync(shop);if($scope.modal){$scope.modal.hide();}else{$state.go("productList",null,{reload:true});}};$scope.clickAddressSuggestions=function($event){$event.stopPropagation();resetFindShopView();};$scope.clickCommunity=function(community,$event){$event.stopPropagation();if(!community.shops||community.shops.length==0){community.showShopNotReadyMessage=true;$timeout(function(){community.showShopNotReadyMessage=false;},1000);return;}if(community.shops&&community.shops.length==1){$scope.goToShop(community.shops[0]);return;}if(community.shops&&community.shops.length>1){community.showShopsInCommunity=!community.showShopsInCommunity;return;}};$scope.toggleShopsInCommunity=function($event,item){$event.stopPropagation();};$scope.readonly=true;$scope.getSuggestions=function(key,$event){if($scope.shop_data.searchQuery&&$scope.shop_data.searchQuery.length>0){$scope.searchButtonText="搜索";}else{$scope.searchButtonText="取消";}httpClient.getCommunitySuggestions(key,function(data,status){var code=data.code,dataDetail=data.data;if(code==0&&!MMUtils.isEmptyObject(dataDetail)&&dataDetail.communitys&&dataDetail.communitys.length){$timeout(function(){$scope.shop_info.address_suggestions=dataDetail.communitys;});}else{$scope.shop_info.address_suggestions=[];}},function(data,status){});};$scope.performSearch=function(key,$event){if($event){$event.target.blur();}if($scope.searchButtonText=="取消"){$scope.searchButtonText="搜索";hideSearchSuggestions();return;}var KEY=key||$scope.shop_data.searchQuery;if(!KEY){return;}$timeout(function(){$scope.shop_info.locationMessage=KEY;});MMUtils.showLoadingIndicator("正在搜索"+KEY+"...",$scope);httpClient.getCommunityByName(key,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(code==0&&!MMUtils.isEmptyObject(dataDetail)){$scope.community_items=_updateShopStatusForCommunity(dataDetail.communitys);}else{$scope.community_items=[];}$scope.shop_info.commmunityListTitle="为您找到的小区";hideSearchSuggestions();},function(data,status){$ionicLoading.hide();$scope.community_items=[];$scope.shop_info.commmunityListTitle="为您找到的小区";hideSearchSuggestions();});};$scope.relocation=function(){function showPosition(position){$ionicLoading.hide();if(position){$timeout(function(){$scope.shop_info.locationReady=true;$scope.shop_info.locationMessage="定位成功,正在获取地址...";});localStorageService.set("MMMETA_location_pos_ready",1);localStorageService.set("MMMETA_location_pos_data",{lat:position.coords.latitude,lng:position.coords.longitude});updateUIWhenPositionDataReady();}else{$timeout(function(){$scope.shop_info.locationReady=false;$scope.shop_info.locationMessage="定位失败！";});}}function showError(){$ionicLoading.hide();$timeout(function(){$scope.shop_info.locationMessage="定位失败！";});}if(navigator.geolocation){var position_option={enableHighAccuracy:true,timeout:10000,maximumAge:0};MMUtils.showLoadingIndicator("正在重新定位",$scope);navigator.geolocation.getCurrentPosition(showPosition,showError,position_option);}else{$scope.shop_info.locationMessage="浏览器不支持定位";}};function updateRealGEOAddressByGEOData(lng,lat,cb){var gpsPoint=new BMap.Point(lng,lat);BMap.Convertor.translate(gpsPoint,0,function(point){var myGeo=new BMap.Geocoder();myGeo.getLocation(point,function(result){if(result){localStorageService.set("MMMETA_location_pos_addr",result.address);$timeout(function(){$scope.shop_info.locationMessage=result.address;});}});if(cb){cb(point);}});}function _updateShopStatusForCommunity(comm_items){for(var i=0;i<comm_items.length;i++){var hasOpenShop=false;if(comm_items[i].shops){for(var j=0;j<comm_items[i].shops.length;j++){if(comm_items[i].shops[j].status==0){hasOpenShop=true;}}}comm_items[i].hasOpenShop=hasOpenShop;}return comm_items;}function updateUIWhenPositionDataReady(){$scope.shop_info.locationReady=localStorageService.get("MMMETA_location_pos_ready");if($scope.shop_info.locationReady){$scope.shop_info.locationData=localStorageService.get("MMMETA_location_pos_data");function onBMAPPointReady(point){$scope.shop_info.loadingCoummnityItems=true;$scope.community_items=null;httpClient.getNearCommunityList(point.lat,point.lng,function(data,status){var code=data.code,dataDetail=data.data;if(code==0||!MMUtils.isEmptyObject(dataDetail)){$timeout(function(){$scope.community_items=_updateShopStatusForCommunity(dataDetail.communitys);});}else{$scope.community_items=[];}$scope.shop_info.loadingCoummnityItems=false;},function(data,status){$timeout(function(){$scope.shop_info.loadingCoummnityItems=false;$scope.community_items=[];$scope.shop_info.commmunityListTitle="附近的小区";});});}updateRealGEOAddressByGEOData($scope.shop_info.locationData.lng,$scope.shop_info.locationData.lat,onBMAPPointReady);}}function resetFindShopView(){$scope.shop_info.showAddressSuggestion=false;$scope.shop_info.commmunityListTitle="附近的小区";}$scope.$on("$ionicView.enter",function(){$scope.shop_info.commmunityListTitle="附近的小区";$scope.searchButtonText="搜索";$timeout(function(){updateUIWhenPositionDataReady();});});});angular.module("miaomiao.shop").controller("ProductCtrl",function($scope,$rootScope,$window,$ionicLoading,$ionicPopup,$ionicModal,$ionicScrollDelegate,$http,$state,$timeout,localStorageService,httpClient,ShoppingCart,OrderService,ShopService,MMUtils){$scope.shop=ShopService.getDefaultShop()||{};if(!$scope.shop){MMUtils.showAlert("加载店铺失败,请重新选择店铺");$state.go("findshop");return;}$scope.info={};$scope.currentDisplayCategory={};$scope.currentDisplayItems=[];$scope.categoryls=[];function initShopData(){MMUtils.showLoadingIndicator("正在加载商品...",$scope);httpClient.getProductList($scope.shop.id,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(!code==0){MMUtils.showAlert("加载数据失败");return;}$scope.shop=dataDetail.shop;$scope.categoryls=dataDetail.categoryls;for(var idx=0;idx<$scope.categoryls.length;idx++){$scope.categoryls[idx].totalCnt=ShoppingCart.getCountForCategroy($scope.categoryls[idx].category_id);$scope.categoryls[idx].selected=0;$scope.categoryls[idx].canLoadMore=1;if(idx==0){$scope.categoryls[idx].selected=1;}if($scope.categoryls[idx].name.length==2){$scope.categoryls[idx].name=$scope.categoryls[idx].name.charAt(0)+"  "+$scope.categoryls[idx].name.charAt(1);}for(var item_idx=0;item_idx<$scope.categoryls[idx].itemls.length;item_idx++){var item=$scope.categoryls[idx].itemls[item_idx];item.count=ShoppingCart.getCountForItem(item);}}$scope.currentDisplayCategory=$scope.categoryls.length&&$scope.categoryls[0];$scope.currentDisplayItems=$scope.currentDisplayCategory&&$scope.currentDisplayCategory.itemls;},function(data,status){$ionicLoading.hide();MMUtils.showAlert("加载数据失败");return;});}$timeout(function(){initShopData();});var canLoadMore=true,inLoadingMore=false;$scope.selectCategory=function(index){if(inLoadingMore){return;}var category=$scope.categoryls[index];for(var idx=0;idx<$scope.categoryls.length;idx++){$scope.categoryls[idx].selected=0;}category.selected=1;$scope.currentDisplayCategory=category;$scope.currentDisplayItems=category.itemls;$ionicScrollDelegate.$getByHandle("productScroll").scrollTop();};$scope.moreDataCanBeLoaded=function(){return $scope.currentDisplayCategory.canLoadMore;};$scope.addItems=function(){var cateId=$scope.currentDisplayCategory.category_id,from=$scope.currentDisplayItems.length,offset=20;inLoadingMore=true;httpClient.getMoreProductList($scope.shop.id,cateId,from,offset,function(data,status){var code=data.code,dataDetail=data.data;if(!code==0||dataDetail.items.length==0){$scope.currentDisplayCategory.canLoadMore=false;inLoadingMore=false;return;}for(var item_idx=0;item_idx<dataDetail.items.length;item_idx++){var item=dataDetail.items[item_idx];item.count=ShoppingCart.getCountForItem(item);}$scope.currentDisplayItems=$scope.currentDisplayItems.concat(dataDetail.items);$scope.currentDisplayCategory.itemls=$scope.currentDisplayItems;$scope.currentDisplayCategory.totalCnt=ShoppingCart.getCountForCategroy($scope.currentDisplayCategory.category_id);inLoadingMore=false;$scope.$broadcast("scroll.infiniteScrollComplete");},function(data,status){inLoadingMore=false;$scope.currentDisplayCategory.canLoadMore=false;$scope.$broadcast("scroll.infiniteScrollComplete");});};function updateShoppingCart(){$timeout(function(){$scope.info.shoppingCartItems=ShoppingCart.getAllItems();$scope.info.cartReadyToShip=ShoppingCart.cartReadyToShip();$scope.info.checkoutHintMessage=$scope.info.cartReadyToShip?"去结算":"差 "+ShoppingCart.cartNotReadyLeftPrice()+" 元起送";});}$scope.selectItem=function(item){item.count+=1;$scope.currentDisplayCategory.totalCnt+=1;ShoppingCart.addItemToCart(item);updateShoppingCart();ShoppingCart.itemChangeEventInProductList(item);};$scope.removeItem=function(item,removeUIElementWhenEmtpy){item.count-=1;item.count=item.count<=0?0:item.count;ShoppingCart.removeItemFromCart(item);updateShoppingCart();ShoppingCart.itemChangeEventInProductList(item);$scope.currentDisplayCategory.totalCnt-=1;$scope.currentDisplayCategory.totalCnt=$scope.currentDisplayCategory.totalCnt>=0?$scope.currentDisplayCategory.totalCnt:0;};$scope.checkout=function(){if(!$scope.info.cartReadyToShip){return;}$state.go("checkout",null,{reload:true});};$scope.goToSearch=function(){$state.go("search",null,{reload:true});};$scope.showShoppingCart=function(){$scope.info.showCart=!$scope.info.showCart;};$ionicModal.fromTemplateUrl("templates/switchShop.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal;});$scope.switchShop=function(){$scope.modal.show();};$scope.$on("modal.hidden",function(){var shop=ShopService.getDefaultShop()||{};if(shop.id!=$scope.shop.id){$timeout(function(){$scope.shop=shop;});checkShopStatus();ShoppingCart.clearAll();updateShoppingCart();$timeout(function(){initShopData();});}});$ionicModal.fromTemplateUrl("templates/productPreview.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.previewModal=modal;});$scope.openPreviewModal=function(){$scope.previewModal.show();};$scope.closePreviewModal=function(){$scope.previewModal.remove();};$scope.showImage=function(item){$scope.imageSrc=item.pic_url;$ionicModal.fromTemplateUrl("templates/productPreview.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.previewModal=modal;$scope.openPreviewModal();});};function fullyUpdateForProductList(){if(!$scope.categoryls){return;}for(var idx=0;idx<$scope.categoryls.length;idx++){$scope.categoryls[idx].totalCnt=ShoppingCart.getCountForCategroy($scope.categoryls[idx].category_id);for(var item_idx=0;item_idx<$scope.categoryls[idx].itemls.length;item_idx++){var itm=$scope.categoryls[idx].itemls[item_idx];itm.count=ShoppingCart.getCountForItem(itm);}}updateShoppingCart();}function partUpdateForProductList(item){if(!$scope.categoryls){return;}for(var idx=0;idx<$scope.categoryls.length;idx++){if($scope.categoryls[idx].category_id==item.category_id){$scope.categoryls[idx].totalCnt=ShoppingCart.getCountForCategroy($scope.categoryls[idx].category_id);for(var item_idx=0;item_idx<$scope.categoryls[idx].itemls.length;item_idx++){var itm=$scope.categoryls[idx].itemls[item_idx];if(itm.id==item.id){itm.count=ShoppingCart.getCountForItem(itm);}}break;}}updateShoppingCart();}ShoppingCart.onItemChangeEventInShoppingCart($scope,function(message){var item=message.item;if(item){partUpdateForProductList(item);}else{fullyUpdateForProductList();}});function checkShopStatus(){var shopInfo=ShopService.getDefaultShop()||{};$timeout(function(){$scope.shop=shopInfo;});httpClient.getShopInfo(shopInfo.id,function(data,status){var code=data.code,dataDetail=data.data;if(dataDetail&&dataDetail.shop&&dataDetail.shop.status!=0){var alertPopup=$ionicPopup.alert({title:dataDetail.shop.name+"打烊啦，去其他店铺看看？",template:""});alertPopup.then(function(res){$scope.currentDisplayItems=[];$state.go("findshop",null,{reload:true});return;});}},function(data,status){});}$scope.$on("$ionicView.afterEnter",function(){checkShopStatus();updateShoppingCart();fullyUpdateForProductList();if(!$scope.currentDisplayItems||!$scope.currentDisplayItems.length){$timeout(function(){initShopData();});}});});angular.module("miaomiao.shop").controller("GoToShopCtrl",function($scope,$stateParams,$rootScope,$window,$ionicLoading,$ionicPopup,$ionicModal,$ionicScrollDelegate,$http,$state,$timeout,localStorageService,httpClient,ShoppingCart,OrderService,ShopService,MMUtils){MMUtils.showLoadingIndicator("正在加载店铺信息",$scope);httpClient.getShopInfo($stateParams.shop_id,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(!code==0){MMUtils.showAlert("加载数据失败");return;}$scope.shop=dataDetail.shop;ShopService.setDefaultShop(dataDetail.shop);$state.go("productList",null,{reload:true});},function(data,status){MMUtils.showAlert("加载店铺信息失败，请刷新");return;});});angular.module("miaomiao.shop").controller("SearchCtrl",function($scope,$rootScope,$ionicLoading,$ionicScrollDelegate,$ionicPopup,$http,$state,$timeout,localStorageService,httpClient,ShoppingCart,ShopService,MMUtils){$scope.shop=ShopService.getDefaultShop()||{};$scope.info={};$scope.performSearch=function(key,$event){$event.target.blur();var KEY=key||$scope.info.key;MMUtils.showLoadingIndicator("正在搜索...",$scope);$scope.info.showSearchSuggestion=false;$scope.info.showSearchResult=true;httpClient.getSearchResults($scope.shop.id,KEY,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(!code==0||dataDetail.length==0){$scope.searchResultsItems=[];$scope.info.hasNoResults=true;return;}$scope.info.hasNoResults=false;for(var item_idx=0;item_idx<dataDetail.length;item_idx++){var item=dataDetail[item_idx];item.count=ShoppingCart.getCountForItem(item);}$scope.searchResultsItems=dataDetail;$ionicScrollDelegate.$getByHandle("searchResultScroll").scrollTop();},function(data,status){$ionicLoading.hide();$scope.info.hasNoResults=true;});};$scope.getSearchSuggestions=function(){httpClient.getSearchSuggestion($scope.shop.id,$scope.info.key,function(data,status){var code=data.code,dataDetail=data.data;$timeout(function(){$scope.info.search_suggestions=dataDetail;});},function(data,status){});};$scope.goToSearchItem=function(item,$event){$scope.info.showSearchSuggestion=false;$scope.info.showSearchResult=true;$event.stopPropagation();$scope.performSearch(item.key,$event);};function updateShoppingCart(){$timeout(function(){$scope.info.shoppingCartItems=ShoppingCart.getAllItems();$scope.info.cartReadyToShip=ShoppingCart.cartReadyToShip();$scope.info.checkoutHintMessage=$scope.info.cartReadyToShip?"去结算":"差 "+ShoppingCart.cartNotReadyLeftPrice()+" 元起送";});}updateShoppingCart();$scope.selectItem=function(item){item.count+=1;ShoppingCart.addItemToCart(item);updateShoppingCart();ShoppingCart.itemChangeEventInProductList(item);};$scope.removeItem=function(item,removeUIElementWhenEmtpy){item.count-=1;item.count=item.count<=0?0:item.count;ShoppingCart.removeItemFromCart(item);updateShoppingCart();ShoppingCart.itemChangeEventInProductList(item);};$scope.startSearch=function(){$scope.info.showSearchSuggestion=true;$scope.info.showSearchResult=false;};$scope.clearSearch=function(){$scope.info.key="";$scope.info.showSearchSuggestion=true;$scope.info.showSearchResult=false;};$scope.checkout=function(){if(!$scope.info.cartReadyToShip){return;}$state.go("checkout",null,{reload:true});};$scope.showShoppingCart=function(){$scope.info.showCart=!$scope.info.showCart;};ShoppingCart.onItemChangeEventInShoppingCart($scope,function(message){var item=message.item;updateShoppingCart();for(var item_idx=0;item_idx<$scope.searchResultsItems.length;item_idx++){var item=$scope.searchResultsItems[item_idx];item.count=ShoppingCart.getCountForItem(item);}});$scope.$on("$ionicView.afterEnter",function(){$scope.shop=ShopService.getDefaultShop()||{};});});angular.module("miaomiao.shop").controller("CheckoutCtrl",function($scope,$rootScope,$timeout,$ionicLoading,$ionicPopup,$http,$state,localStorageService,httpClient,ShoppingCart,AddressService,OrderService,ShopService,MMUtils,WeiChatPay){$scope.shoppingCartItems=ShoppingCart.getAllItems();$scope.shop=ShopService.getDefaultShop()||{};$scope.info={};$scope.info.address={};$scope.info.newOrderAddress="";$scope.info.newOrderPhone="";$scope.info.dataReady=false;$scope.CheckoutTypeEnum={CHECKOUTTYPE_CASH:1,CHECKOUTTYPE_WXPAY:2,CHECKOUTTYPE_ALIPAY:3};if($scope.shop.id=="10033"){$scope.checkoutType=[{id:$scope.CheckoutTypeEnum.CHECKOUTTYPE_CASH,name:"货到付款",selected:true},{id:$scope.CheckoutTypeEnum.CHECKOUTTYPE_WXPAY,name:"微信支付",selected:false}];}else{$scope.checkoutType=[{id:$scope.CheckoutTypeEnum.CHECKOUTTYPE_CASH,name:"货到付款",selected:true}];}function checkOrders(){$scope.info.remarks="";MMUtils.showLoadingIndicator("正在查看库存,请稍候...",$scope);httpClient.getConfirmCartList($scope.shop.id,ShoppingCart.getAllItems(),function(data,status){$ionicLoading.hide();$scope.info.dataReady=true;var code=data.code,dataDetail=data.data;if(code==500){MMUtils.showAlert("加载数据失败:"+data.msg);return;}else{if(code==100){MMUtils.showAlert("部分商品不足，您可以购买部分商品:"+data.msg);}}$scope.shop=dataDetail.shop;for(var i=0;i<dataDetail.itemls.length;i++){var item=dataDetail.itemls[i];for(var j=0;j<$scope.shoppingCartItems.length;j++){if(item.id==$scope.shoppingCartItems[j].id){if(item.info){$scope.shoppingCartItems[j].message=item.info;}}}}$scope.addressls=dataDetail.addressls;$scope.info.address=$scope.addressls&&$scope.addressls.length&&$scope.addressls[0];if(!$scope.info.address){$scope.info.showAddNewAddress=true;}},function(data,status){$ionicLoading.hide();$scope.info.dataReady=true;});}$scope.selectCheckoutType=function(index){for(var i=0;i<$scope.checkoutType.length;i++){if(index!=i){$scope.checkoutType[i].selected=false;}}$scope.checkoutType[index].selected=true;_updateCheckoutHintMessage();};$scope.goToAddressList=function(){$state.go("addressList",null,{reload:true});};$scope.goback=function(){$state.go("productList",null,{reload:true});};$scope.cartReadyToShip=ShoppingCart.cartReadyToShip();$scope.selectItem=function(item){item.count+=1;ShoppingCart.itemChangeEventInShoppingCart(item);updateShoppingCart();};$scope.removeItem=function(item,removeUIElementWhenEmtpy){item.count-=1;if(item.count<=0){item.count=0;ShoppingCart.removeItemFromCart(item);}ShoppingCart.itemChangeEventInShoppingCart(item);updateShoppingCart();};$scope.confirmCheckout=function(){if(!$scope.cartReadyToShip){return;}if($scope.addressls&&$scope.addressls.length){$scope.info.address=$scope.addressls[0];}else{$scope.info.address={id:"",address:$scope.info.newOrderAddress,phone:$scope.info.newOrderPhone};if(!$scope.info.newOrderAddress||!$scope.info.newOrderPhone||!MMUtils.isValidTelNumber($scope.info.newOrderPhone)){MMUtils.showAlert("请填写正确的地址电话");return;}$scope.addressls=$scope.addressls||[];$scope.addressls[0]=$scope.info.address;$scope.info.showAddNewAddress=false;}var selectCheckoutType=$scope.checkoutType[0];for(var i=0;i<$scope.checkoutType.length;i++){if($scope.checkoutType[i].selected){selectCheckoutType=$scope.checkoutType[i];break;}}if(selectCheckoutType.id==$scope.CheckoutTypeEnum.CHECKOUTTYPE_CASH){MMUtils.showLoadingIndicator("正在生成订单,请稍候...",$scope);httpClient.getOrderSave($scope.shop.id,$scope.info.address.id,$scope.info.address.address,$scope.info.address.phone,$scope.info.remarks||"",$scope.shoppingCartItems,$scope.info.order_id,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(code==500){MMUtils.showAlert("生成订单失败，请重新购买:"+data.msg);return;}else{if(code==100){MMUtils.showAlert("部分商品不足，请重新购买:"+data.msg);return;}}ShoppingCart.clearAll();updateShoppingCart();$state.go("myOrders",null,{reload:true});},function(data,status){$ionicLoading.hide();MMUtils.showAlert("生成订单失败，请重新购买");});}else{if(selectCheckoutType.id==$scope.CheckoutTypeEnum.CHECKOUTTYPE_WXPAY){function onWeixinPaySuccess(shopId,orderId,message){httpClient.updateOrderStatus(shopId,orderId,message,function(data,status){ShoppingCart.clearAll();updateShoppingCart();$state.go("myOrders",null,{reload:true});},function(data,status){MMUtils.showAlert("支付成功，但是订单出现未知错误");return;});}function onWeixinPayFailed(shopId,orderId,message){httpClient.updateOrderStatus(shopId,orderId,message,function(data,status){console.log("订单出现未知错误");return;},function(data,status){});}httpClient.getOrderPrepayInfo($scope.shop.id,$scope.info.address.id,$scope.info.address.address,$scope.info.address.phone,$scope.info.remarks||"",$scope.shoppingCartItems,$scope.info.order_id,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data,order_id,cbMessage,pkg;if(code!=0){MMUtils.showAlert("生成订单失败，请重新购买:"+data.msg);return;}order_id=dataDetail.order_id;pkg={prepay_id:dataDetail.pre_id};if(!WeiChatPay.chooseWXPay){MMUtils.showAlert("暂时无法使用微信购买,请选择其他支付方式");return;}window.alert("the prepay_id is:"+JSON.stringify(pkg)+" and the order id is:"+order_id);MMUtils.showLoadingIndicator("请稍候...",$scope);WeiChatPay.chooseWXPay(pkg,function(){$ionicLoading.hide();},function(){MMUtils.showAlert("微信支付成功");onWeixinPaySuccess($scope.shop.id,order_id,"paydone");},function(){MMUtils.showAlert("微信支付失败");onWeixinPayFailed($scope.shop.id,order_id,"微信支付失败");});},function(data,status){$ionicLoading.hide();MMUtils.showAlert("生成订单失败，请重试");});}}};function updateDefaultOrderAddress(addr){if(addr){$scope.addressls=$scope.addressls||[];$scope.addressls[0]=addr;$scope.info.address=$scope.addressls[0];}else{MMUtils.showLoadingIndicator("正在更新地址...",$scope);httpClient.getAddressList($scope.shop.id,function(data,status){var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("加载数据失败:"+data.msg);return;}$ionicLoading.hide();$scope.addressls=dataDetail.addressls||[];},function(data,status){$scope.addressls=[];MMUtils.showAlert("加载数据失败,请重试");});}}function _getCheckoutTypeDisplayMessage(){for(var i=0;i<$scope.checkoutType.length;i++){if($scope.checkoutType[i].selected){return $scope.checkoutType[i].name;}}return"货到付款";}function _updateCheckoutHintMessage(){$scope.checkoutHintMessage=$scope.cartReadyToShip?_getCheckoutTypeDisplayMessage():"差 "+ShoppingCart.cartNotReadyLeftPrice()+" 元起送";}function updateShoppingCart(){$timeout(function(){$scope.shoppingCartItems=ShoppingCart.getAllItems();$scope.cartReadyToShip=ShoppingCart.cartReadyToShip();_updateCheckoutHintMessage();});}AddressService.onAddressChangeEventSwitchDefault($scope,function(message){updateDefaultOrderAddress(message.item);});AddressService.onAddressChangeEventAddNew($scope,function(message){updateDefaultOrderAddress(message.item);});OrderService.onOrderChangeEventSuccess($scope,function(){updateShoppingCart();});$scope.$on("$ionicView.afterEnter",function(){$scope.shop=ShopService.getDefaultShop()||{};updateShoppingCart();checkOrders();});});angular.module("miaomiao.shop").controller("AddressListCtrl",function($scope,$ionicLoading,$http,$state,$ionicPopup,localStorageService,httpClient,AddressService,ShopService,MMUtils){$scope.shop=ShopService.getDefaultShop()||{};function updateAddress(){MMUtils.showLoadingIndicator("正在加载地址列表...",$scope);httpClient.getAddressList($scope.shop.id,function(data,status){var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("加载数据失败:"+data.msg);return;}$ionicLoading.hide();$scope.shop=dataDetail.shop;$scope.addressls=dataDetail.addressls||[];if($scope.addressls&&$scope.addressls.length){$scope.addressls[0].isDefault=true;}},function(data,status){$scope.addressls=[];MMUtils.showAlert("加载数据失败,请刷新");});}$scope.goToAddNewAddress=function(){$state.go("addAddress");};$scope.setDefaultAddress=function(addr){for(var i=0;i<$scope.addressls.length;i++){$scope.addressls[i].isDefault=false;}addr.isDefault=true;MMUtils.showLoadingIndicator("正在切换默认地址...",$scope);httpClient.setDefaultAddress($scope.shop.id,addr,function(data,status){var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("切换默认地址失败:"+data.msg);return;}$ionicLoading.hide();$state.go("checkout",null,{reload:true});AddressService.addressChangeEventSwitchDefault(addr);},function(data,status){$ionicLoading.hide();MMUtils.showAlert("切换默认地址失败");});};$scope.addNewAddressConfirm=function(){if(!$scope.newAddress.address||!$scope.newAddress.phone||!MMUtils.isValidTelNumber($scope.newAddress.phone)){MMUtils.showAlert("请填写正确的地址电话");return;}MMUtils.showLoadingIndicator("正在添加新地址...",$scope);httpClient.addAddress($scope.shop.id,$scope.newAddress,function(data,status){var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("添加新地址失败:"+data.msg);return;}$ionicLoading.hide();$state.go("checkout",null,{reload:true});AddressService.addressChangeEventAddNew($scope.newAddress);},function(data,status){$ionicLoading.hide();MMUtils.showAlert("添加新地址失败,请刷新");});};$scope.$on("$ionicView.enter",function(){$scope.newAddress={};updateAddress();});});angular.module("miaomiao.shop").controller("ProductDetailCtrl",["$scope","$ionicModal",function($scope,$ionicModal){$ionicModal.fromTemplateUrl("templates/productPreview.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal;});$scope.openModal=function(){$scope.modal.show();};$scope.closeModal=function(){$scope.modal.hide();};$scope.$on("$destroy",function(){$scope.modal.remove();});$scope.$on("modal.hide",function(){});$scope.$on("modal.removed",function(){});$scope.$on("modal.shown",function(){});$scope.showImage=function(item){$scope.imageSrc=item.pic_url;$scope.openModal();};}]);angular.module("miaomiao.shop").controller("MyOrdersCtrl",function($scope,$ionicLoading,$ionicPopup,$timeout,$http,$state,$ionicScrollDelegate,localStorageService,$sessionStorage,httpClient,AddressService,OrderService,ShopService,MMUtils){$scope.shop=ShopService.getDefaultShop()||{};$scope.goToAddressList=function(){$state.go("userAddressList",null,{reload:true});};$scope.backToHome=function(){$state.go("productList");};function transformOrderData(orders){if(!orders){return;}for(var i=0;i<orders.length;i++){var order=orders[i];try{order.items=JSON.parse(order.snapshot);}catch(e){}}}$scope.info={};$scope.info.hasShop=$scope.shop&&$scope.shop.id!=null;$scope.addr={};$scope.addressls=$sessionStorage.MMMETA_OrderAddresses||[];$scope.orders=$sessionStorage.MMMETA_OrderOrders||[];transformOrderData($scope.orders);function reloadInfo(addr){if(addr){$scope.addressls=$scope.addressls||[];$scope.addressls[0]=addr;$scope.info.address=$scope.addressls[0];}else{MMUtils.showLoadingIndicator("正在加载,请稍候...",$scope);$scope.info.hasShop=$scope.shop&&$scope.shop.id!=null;httpClient.getMyOrders($scope.shop.id,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;$scope.shop=dataDetail.shop;$scope.addressls=dataDetail.addressls;$scope.info.hasAddress=$scope.addressls.length>0?true:false;$scope.orders=dataDetail.orders;transformOrderData($scope.orders);$scope.info.hasOrder=$scope.orders.length>0?true:false;$timeout(function(){if($scope.orders.length>=1){$scope.latestOrder=$scope.orders.slice(0,1);}if($scope.orders.length>1){$scope.historyOrder=$scope.orders.slice(1);}});$sessionStorage.orderAddresses=$scope.addressls;$sessionStorage.orderOrders=$scope.orders;$ionicScrollDelegate.resize();},function(data,status){$scope.info.hasOrder=false;$scope.info.hasAddress=false;$ionicScrollDelegate.resize();$ionicLoading.hide();});}}$scope.addNewAddressInOrderPage=function(){if(!$scope.addr.address||!$scope.addr.phone||!MMUtils.isValidTelNumber($scope.addr.phone)){MMUtils.showAlert("请填写正确的地址电话");return;}MMUtils.showLoadingIndicator("正在添加新地址...",$scope);var shopId=$scope.shop&&$scope.shop.id||1;httpClient.addAddress(shopId,$scope.addr,function(data,status){var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("添加新地址失败:"+data.msg);return;}$ionicLoading.hide();AddressService.addressChangeEventAddNew($scope.addr);$ionicScrollDelegate.resize();$state.go("myOrders",null,{reload:true});},function(data,status){$ionicLoading.hide();MMUtils.showAlert("添加新地址失败,请重试");$ionicScrollDelegate.resize();});};$scope.switchToAddressList=function($event){$event.target.blur();$event.stopPropagation();$state.go("userAddressList",null,{reload:true});};$scope.goToShopOrFindShop=function(){var lastShop=ShopService.getDefaultShop();if(lastShop&&lastShop.id){$state.go("productList",null,{reload:true});}else{$state.go("findshop",null,{reload:true});}};OrderService.orderChangeEventSuccess();AddressService.onAddressChangeEventSwitchDefault($scope,function(message){reloadInfo(message.item);});AddressService.onAddressChangeEventAddNew($scope,function(message){reloadInfo(message.item);});$scope.$on("$ionicView.enter",function(){$scope.shop=ShopService.getDefaultShop()||{};reloadInfo();});});angular.module("miaomiao.shop").controller("ShoppingCartCtrl",function($scope,$ionicLoading,$http,$state,localStorageService,ShoppingCart){$scope.info=$scope.info||{};$scope.info.shoppingCartItems=ShoppingCart.getAllItems();$scope.selectItem=function(item){item.count+=1;ShoppingCart.itemChangeEventInShoppingCart(item);};$scope.removeItem=function(item,removeUIElementWhenEmtpy){item.count-=1;if(item.count<=0){item.count=0;ShoppingCart.removeItemFromCart(item);}ShoppingCart.itemChangeEventInShoppingCart(item);};$scope.clearShoppingCart=function(){$scope.info.shoppingCartItems=[];ShoppingCart.clearAll();};ShoppingCart.onItemChangeEventInProductList($scope,function(message){$scope.info.shoppingCartItems=ShoppingCart.getAllItems();});});angular.module("miaomiao.shop").controller("UserAddressListCtrl",function($scope,$ionicLoading,$ionicPopup,$http,$ionicScrollDelegate,$state,localStorageService,httpClient,AddressService,ShopService,MMUtils){$scope.shop=ShopService.getDefaultShop()||{};function updateAddress(){MMUtils.showLoadingIndicator("正在加载地址列表",$scope);httpClient.getAddressList($scope.shop.id,function(data,status){var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("加载数据失败:"+data.msg);return;}$ionicLoading.hide();$scope.shop=dataDetail.shop;$scope.addressls=dataDetail.addressls||[];if($scope.addressls&&$scope.addressls.length){$scope.addressls[0].isDefault=true;}},function(data,status){$scope.addressls=[];MMUtils.showAlert("加载数据失败,请刷新");});}$scope.goToAddNewAddress=function(){$state.go("userAddAddress");};$scope.setDefaultAddress=function(addr){for(var i=0;i<$scope.addressls.length;i++){$scope.addressls[i].isDefault=false;}addr.isDefault=true;MMUtils.showLoadingIndicator("正在切换默认地址...",$scope);httpClient.setDefaultAddress($scope.shop.id,addr,function(data,status){var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("切换默认地址失败:"+data.msg);return;}$ionicLoading.hide();AddressService.addressChangeEventSwitchDefault(addr);$state.go("myOrders",null,{reload:true});},function(data,status){$ionicLoading.hide();MMUtils.showAlert("加载数据失败,请刷新");});};$scope.addNewAddressConfirm=function(){if(!$scope.newAddress.address||!$scope.newAddress.phone||!MMUtils.isValidTelNumber($scope.newAddress.phone)){MMUtils.showAlert("请填写正确的地址电话");return;}MMUtils.showLoadingIndicator("正在添加新地址...",$scope);httpClient.addAddress($scope.shop.id,$scope.newAddress,function(data,status){var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("添加新地址失败:"+data.msg);return;}$ionicLoading.hide();AddressService.addressChangeEventAddNew($scope.newAddress);$state.go("myOrders",null,{reload:true});},function(data,status){$ionicLoading.hide();MMUtils.showAlert("添加新地址失败");});};$scope.$on("$ionicView.enter",function(){$scope.newAddress={};updateAddress();});});