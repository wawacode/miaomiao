angular.module("miaomiao.shop").controller("FindShopCtrl",function(m,k,a,h,j,g,e,l,c){m.shop_data={};m.shop_items=[];m.shop_info={};m.shop_info.showShopList=false;m.shop_info.showShopHistory=false;m.shop_info.showAddressSuggestion=false;m.shop_info.locationReady=g.get("MMMETA_location_pos_ready");if(!m.shop_info.locationReady){m.shop_info.locationMessage="定位失败,您可以搜索你所在的小区";}else{m.shop_info.locationMessage="定位成功，正在加载地址...";}m.shop_history=g.get("MMMETA_shop_history")||[];if(m.shop_history.length){m.shop_info.showShopHistory=true;}m.clearSearch=function(){m.shop_data.searchQuery="";m.shop_info.startSearch=false;b();};function f(){m.shop_info.showAddressSuggestion=true;m.shop_info.showShopList=false;m.shop_info.showShopHistory=false;}function b(){m.shop_info.showAddressSuggestion=false;m.shop_info.showShopList=true;if(m.shop_history.length){m.shop_info.showShopHistory=true;}}m.startSearch=function(){m.shop_info.startSearch=true;f();};m.goToShop=function(o){if(o.status!=undefined&&o.status!=0){return;}var p=false;for(var n=0;n<m.shop_history.length;n++){if(o.id==m.shop_history[n].id){p=true;break;}}if(!p){m.shop_history.push(o);}g.set("MMMETA_shop_history",m.shop_history);g.set("MMMETA_shop",o);if(m.modal){m.modal.hide();}else{a.go("productList",null,{reload:true});}};m.readonly=true;m.getSuggestions=function(q,o){m.shop_info.isGettingSuggestions=true;var n={onSearchComplete:function(s){if(p.getStatus()==BMAP_STATUS_SUCCESS){var t=[];for(var r=0;r<s.getCurrentNumPois();r++){t.push({title:s.getPoi(r).title,address:s.getPoi(r).address});}c(function(){m.shop_info.address_suggestions=t;});}m.shop_info.isGettingSuggestions=false;}};var p=new BMap.LocalSearch("北京市",n);p.search(q);};m.goToSearchAddress=function(n){c(function(){m.shop_info.locationMessage=n.title;});m.performSearch(n.title);};m.performSearch=function(p,o){if(o){o.target.blur();}var n=p||m.shop_data.searchQuery;c(function(){m.shop_info.locationMessage=n;m.shop_info.startSearch=false;});m.LoadingMessage="正在搜索"+n+"附近的店...";j.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:m});var q=new BMap.Geocoder();q.getPoint(n,function(r){if(r){e.getNearShopList(r.lat,r.lng,function(w,s){j.hide();var u=w.code,v=w.data;if(u==0&&!l.isEmptyObject(v)){m.shop_items=v.shops;for(var t=0;t<m.shop_items.length;t++){m.shop_items[t].rate=5;m.shop_items[t].maxRate=5;}}else{m.shop_items=[];}b();},function(t,s){j.hide();b();});}else{j.hide();b();}},"北京市");};m.relocation=function(){function o(q){j.hide();if(q){c(function(){m.shop_info.locationMessage="定位成功,正在获取地址...";});g.set("MMMETA_location_pos_ready",1);g.set("MMMETA_location_pos_data",{lat:q.coords.latitude,lng:q.coords.longitude});i();}else{c(function(){m.shop_info.locationMessage="定位失败！";});}}function n(){j.hide();c(function(){m.shop_info.locationMessage="定位失败！";});}if(navigator.geolocation){var p={timeout:10000};m.LoadingMessage="正在重新定位...";j.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:m});navigator.geolocation.getCurrentPosition(o,n,p);}else{m.shop_info.locationMessage="浏览器不支持定位";}};function d(n,o){var p=new BMap.Geocoder();p.getLocation(new BMap.Point(n,o),function(q){if(q){g.set("MMMETA_location_pos_addr",q.address);c(function(){m.shop_info.locationMessage=q.address;});}});}function i(){m.shop_info.locationReady=g.get("MMMETA_location_pos_ready");if(m.shop_info.locationReady){m.shop_info.locationData=g.get("MMMETA_location_pos_data");d(m.shop_info.locationData.lng,m.shop_info.locationData.lat);e.getNearShopList(m.shop_info.locationData.lat,m.shop_info.locationData.lng,function(q,n){var o=q.code,p=q.data;if(o==0||!l.isEmptyObject(p)){c(function(){m.shop_items=p.shops;for(var r=0;r<m.shop_items.length;r++){m.shop_items[r].rate=5;m.shop_items[r].maxRate=5;}m.shop_info.showAddressSuggestion=false;m.shop_info.showShopList=true;});}},function(o,n){c(function(){m.shop_info.showAddressSuggestion=false;m.shop_info.showShopList=true;});});}}c(function(){i();});m.$on("$ionicView.enter",function(){m.shop_info.showShopList=false;m.shop_info.showShopHistory=false;m.shop_info.showAddressSuggestion=false;if(m.shop_history.length){m.shop_info.showShopHistory=true;}if(m.shop_items.length){m.shop_info.showShopList=true;}});});