angular.module("miaomiao.shop").controller("ProductCtrl",function(n,g,k,h,j,d,t,u,r,s,f,o,e,i){n.shop=f.get("MMMETA_shop");if(!n.shop){j.alert({title:"加载店铺失败,请重新选择店铺",template:""});r.go("findshop");return;}n.info={};n.currentDisplayCategory={};n.currentDisplayItems=[];n.categoryls=[];function b(){n.LoadingMessage="正在加载商品 ...";h.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:n,noBackdrop:true});o.getProductList(n.shop.id,function(A,w){h.hide();var y=A.code,z=A.data;if(!y==0){j.alert({title:"加载数据失败",template:""});return;}n.shop=z.shop;if(n.shop){f.set("MMMETA_shop",n.shop);}n.categoryls=z.categoryls;for(var v=0;v<n.categoryls.length;v++){n.categoryls[v].totalCnt=e.getCountForCategroy(n.categoryls[v].category_id);n.categoryls[v].selected=0;n.categoryls[v].canLoadMore=1;if(v==0){n.categoryls[v].selected=1;}if(n.categoryls[v].name.length==2){n.categoryls[v].name=n.categoryls[v].name.charAt(0)+"  "+n.categoryls[v].name.charAt(1);}for(var B=0;B<n.categoryls[v].itemls.length;B++){var x=n.categoryls[v].itemls[B];x.count=e.getCountForItem(x);}}n.currentDisplayCategory=n.categoryls.length&&n.categoryls[0];n.currentDisplayItems=n.currentDisplayCategory&&n.currentDisplayCategory.itemls;},function(w,v){h.hide();j.alert({title:"加载数据失败",template:""});return;});}s(function(){b();});var l=true,p=false;n.selectCategory=function(w){if(p){return;}for(var v=0;v<n.categoryls.length;v++){n.categoryls[v].selected=0;}w.selected=1;n.currentDisplayCategory=w;n.currentDisplayItems=w.itemls;t.$getByHandle("productScroll").scrollTop();};n.moreDataCanBeLoaded=function(){return n.currentDisplayCategory.canLoadMore;};n.addItems=function(){var w=n.currentDisplayCategory.category_id,x=n.currentDisplayItems.length,v=20;p=true;o.getMoreProductList(n.shop.id,w,x,v,function(C,y){var A=C.code,B=C.data;if(!A==0||B.items.length==0){n.currentDisplayCategory.canLoadMore=false;p=false;return;}for(var D=0;D<B.items.length;D++){var z=B.items[D];z.count=e.getCountForItem(z);}n.currentDisplayItems=n.currentDisplayItems.concat(B.items);n.currentDisplayCategory.totalCnt=e.getCountForCategroy(n.currentDisplayCategory.category_id);p=false;n.$broadcast("scroll.infiniteScrollComplete");},function(z,y){p=false;n.currentDisplayCategory.canLoadMore=false;n.$broadcast("scroll.infiniteScrollComplete");});};function a(){s(function(){n.info.shoppingCartItems=e.getAllItems();n.info.cartReadyToShip=e.cartReadyToShip();n.info.checkoutHintMessage=n.info.cartReadyToShip?"去结算":"差 "+e.cartNotReadyLeftPrice()+" 元起送";});}n.selectItem=function(v){v.count+=1;n.currentDisplayCategory.totalCnt+=1;e.addItemToCart(v);a();e.itemChangeEventInProductList(v);};n.removeItem=function(w,v){w.count-=1;w.count=w.count<=0?0:w.count;e.removeItemFromCart(w);a();e.itemChangeEventInProductList(w);n.currentDisplayCategory.totalCnt-=1;n.currentDisplayCategory.totalCnt=n.currentDisplayCategory.totalCnt>=0?n.currentDisplayCategory.totalCnt:0;};n.checkout=function(){f.set("MMMETA_shop",n.shop);if(!n.info.cartReadyToShip){return;}r.go("checkout",null,{reload:true});};n.goToSearch=function(){r.go("search",null,{reload:true});};n.showShoppingCart=function(){n.info.showCart=!n.info.showCart;};d.fromTemplateUrl("/views/sg/templates/switchShop.html",{scope:n,animation:"slide-in-up"}).then(function(v){n.modal=v;});n.switchShop=function(){n.modal.show();};n.$on("modal.hidden",function(){var v=f.get("MMMETA_shop");if(v.id!=n.shop.id){s(function(){n.shop=v;});q();e.clearAll();a();s(function(){b();});}});d.fromTemplateUrl("/views/sg/templates/productPreview.html",{scope:n,animation:"slide-in-up"}).then(function(v){n.previewModal=v;});n.openPreviewModal=function(){n.previewModal.show();};n.closePreviewModal=function(){n.previewModal.remove();};n.showImage=function(v){n.imageSrc=v.pic_url;d.fromTemplateUrl("/views/sg/templates/productPreview.html",{scope:n,animation:"slide-in-up"}).then(function(w){n.previewModal=w;n.openPreviewModal();});};function m(){if(!n.categoryls){return;}for(var v=0;v<n.categoryls.length;v++){n.categoryls[v].totalCnt=e.getCountForCategroy(n.categoryls[v].category_id);for(var w=0;w<n.categoryls[v].itemls.length;w++){var x=n.categoryls[v].itemls[w];x.count=e.getCountForItem(x);}}a();}function c(w){if(!n.categoryls){return;}for(var v=0;v<n.categoryls.length;v++){if(n.categoryls[v].category_id==w.category_id){n.categoryls[v].totalCnt=e.getCountForCategroy(n.categoryls[v].category_id);for(var x=0;x<n.categoryls[v].itemls.length;x++){var y=n.categoryls[v].itemls[x];if(y.id==w.id){y.count=e.getCountForItem(y);}}break;}}a();}e.onItemChangeEventInShoppingCart(n,function(w){var v=w.item;if(v){c(v);}else{m();}});function q(){var v=f.get("MMMETA_shop");s(function(){n.shop=v;});o.getShopInfo(v.id,function(A,w){var y=A.code,z=A.data;if(z.shop&&z.shop.status!=0){var x=j.alert({title:z.shop.name+"打烊啦，去其他店铺看看？",template:""});x.then(function(B){r.go("findshop",null,{reload:true});return;});}},function(x,w){});}n.$on("$ionicView.enter",function(){q();a();m();if(!n.currentDisplayItems||!n.currentDisplayItems.length){s(function(){b();});}});});