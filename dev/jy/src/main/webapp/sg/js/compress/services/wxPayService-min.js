angular.module("miaomiao.shop").factory("WeiChatPay",function($http,MMUtils,httpClient,ShopService){var hasBeenInit=false;var weiChatPayUtils={},wechatConfig={appId:"wx762f832959951212",mch_id:"1233699402",appsecret:"914f4388312ca90e4cb750b817d15368"};if(typeof(wx)=="undefined"){console.log("Error微信js-sdk 没有加载");return weiChatPayUtils;}if(!hasBeenInit){var shop=ShopService.getDefaultShop()||{};if(shop&&!ShopService.isWeixinEnabledShop(shop)){return weiChatPayUtils;}var config={appId:wechatConfig.appId,jsApiList:["chooseWXPay"]};var url=window.location.href.split("#")[0];httpClient.getPageConfig(url,function(data,status){if(data&&data.data&&data.data.signature){var detail=data.data;config.signature=detail.signature.toUpperCase();config.nonceStr=detail.nonceStr;config.timestamp=detail.timestamp;wx.config(config);}},function(){});wx.error(function(res){});wx.ready(function(){weiChatPayUtils.checkPayAPI=function(success,fail){wx.checkJsApi({jsApiList:["chooseWXPay"],success:function(res){if(res.checkResult.chooseWXPay){success();}else{fail();}},fail:function(){fail();}});};weiChatPayUtils.chooseWXPay=function(info,beforeHandoverToWCPay,success,fail){var pkg="";for(var p in info){pkg+=p+"="+info[p]+"&";}pkg=pkg.slice(0,-1);var info={signType:"MD5","package":pkg};function onHashReady(){info.success=function(res){if(res.errMsg=="chooseWXPay:ok"){success(res.errMsg);}else{fail("支付失败:"+res.errMsg);}};info.fail=function(res){fail("支付失败:JS-API失败");};info.cancel=function(res){fail("支付取消");};wx.chooseWXPay(info);}httpClient.getHashFromServer(info["package"],info.signType,function(data,status){var detail=data.data;info.paySign=detail.signature.toUpperCase();info.nonceStr=detail.nonceStr;info.timestamp=detail.timestamp;if(beforeHandoverToWCPay){beforeHandoverToWCPay();}onHashReady();},function(data,status){if(beforeHandoverToWCPay){beforeHandoverToWCPay();}fail("获取订单hash出错");});};});hasBeenInit=true;}return weiChatPayUtils;});