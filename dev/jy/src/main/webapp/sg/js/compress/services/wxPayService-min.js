angular.module("miaomiao.shop").factory("WeiChatPay",function($http,MMUtils,httpClient){if(!wx){console.log("Error微信js-sdk 没有加载");return;}var hasBeenInit=false;var weiChatPayUtils={},wechatConfig={appId:"wx762f832959951212",mch_id:"1233699402",appsecret:"914f4388312ca90e4cb750b817d15368"};weiChatPayUtils.getNonceStr=function(){return Math.random().toString(36).substr(2,15);};weiChatPayUtils.getHashCondidate=function(params){var objKeys=Object.keys(params);objKeys=objKeys.sort();var str="";for(var i=0;i<objKeys.length;i++){str+=objKeys[i].toLowerCase()+"="+params[objKeys[i]]+"&";}var stringSignTemp=str+"key="+wechatConfig.appsecret;return stringSignTemp;};weiChatPayUtils.getHash=function(params){var objKeys=Object.keys(params);objKeys=objKeys.sort();var str="";for(var i=0;i<objKeys.length;i++){str+=objKeys[i].toLowerCase()+"="+params[objKeys[i]]+"&";}var stringSignTemp=str+"key="+wechatConfig.appsecret;return MMUtils.hex_md5(stringSignTemp).toUpperCase();};weiChatPayUtils.getTimestamp=function(){return parseInt(new Date().getTime()/1000)+"";};if(!hasBeenInit){var config={debug:true,appId:wechatConfig.appId,jsApiList:["chooseWXPay"]};httpClient.getPageConfig(window.location.href.split("#")[0],function(data,status){if(data&&data.data){var detail=data.data;config.signature=detail.signature.toUpperCase();config.nonceStr=detail.nonceStr;config.timestamp=detail.timestamp;wx.config(config);}},function(){});wx.error(function(res){});wx.ready(function(){weiChatPayUtils.checkPayAPI=function(success,fail){wx.checkJsApi({jsApiList:["chooseWXPay"],success:function(res){if(res.checkResult.chooseWXPay){success();}else{fail();}},fail:function(){fail();}});};weiChatPayUtils.chooseWXPay=function(info,beforeHandoverToWCPay,success,fail){var pkg="";for(var p in info){pkg+=p+"="+info[p]+"&";}pkg=pkg.slice(0,-1);var info={signType:"MD5","package":pkg};function onHashReady(){info.success=function(res){if(res.err_msg=="get_brand_wcpay_request:ok"){success(res);}else{fail(res);}};if(beforeHandoverToWCPay){beforeHandoverToWCPay();}wx.chooseWXPay(info);}httpClient.getHashFromServer(info["package"],info.signType,function(data,status){var detail=data.data;info.paySign=detail.signature.toUpperCase();info.nonceStr=detail.nonceStr;info.timestamp=detail.timestamp;window.alert("weixin pay info:"+JSON.stringify(info));onHashReady();},function(data,status){fail();});};});hasBeenInit=true;}return weiChatPayUtils;});