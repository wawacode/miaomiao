angular.module("miaomiao.shop").factory("WeiChatPay",function($http,MMUtils,httpClient,ShopService){if(!wx){console.log("Error微信js-sdk 没有加载");return;}var hasBeenInit=false;var weiChatPayUtils={},wechatConfig={appId:"wx762f832959951212",mch_id:"1233699402",appsecret:"914f4388312ca90e4cb750b817d15368"};if(!hasBeenInit){var shop=ShopService.getDefaultShop()||{};if(shop&&shop.id!="10033"){return weiChatPayUtils;}var config={debug:true,appId:wechatConfig.appId,jsApiList:["chooseWXPay"]};var url=window.location.href.split("#")[0];httpClient.getPageConfig(url,function(data,status){if(data&&data.data&&data.data.signature){var detail=data.data;config.signature=detail.signature.toUpperCase();config.nonceStr=detail.nonceStr;config.timestamp=detail.timestamp;wx.config(config);}},function(){});wx.error(function(res){});wx.ready(function(){weiChatPayUtils.checkPayAPI=function(success,fail){wx.checkJsApi({jsApiList:["chooseWXPay"],success:function(res){if(res.checkResult.chooseWXPay){success();}else{fail();}},fail:function(){fail();}});};weiChatPayUtils.chooseWXPay=function(info,beforeHandoverToWCPay,success,fail){var pkg="";for(var p in info){pkg+=p+"="+info[p]+"&";}pkg=pkg.slice(0,-1);var info={signType:"MD5","package":pkg};function onHashReady(){info.success=function(res){window.alert("微信支付API返回："+JSON.stringify(res));if(res.err_msg=="get_brand_wcpay_request:ok"){success(res.err_msg);}else{fail("支付失败:"+res.err_msg);}};info.fail=function(){fail("支付失败:JS-API失败");};if(beforeHandoverToWCPay){beforeHandoverToWCPay();}wx.chooseWXPay(info);}httpClient.getHashFromServer(info["package"],info.signType,function(data,status){var detail=data.data;info.paySign=detail.signature.toUpperCase();info.nonceStr=detail.nonceStr;info.timestamp=detail.timestamp;onHashReady();},function(data,status){fail("获取订单hash出错");});};});hasBeenInit=true;}return weiChatPayUtils;});