angular.module("miaomiao.shop").factory("WeiChatPay",function($http,MMUtils){if(!wx){console.log("Error微信js-sdk 没有加载");return;}var weiChatPayUtils={};var wechatConfig={appId:"wx762f832959951212",mch_id:"1233699402",appsecret:"914f4388312ca90e4cb750b817d15368"};wx.config({debug:true,appId:"",timestamp:"",nonceStr:"",signature:"",jsApiList:[]}).ready(function(){weiChatPayUtils.checkPayAPI=function(success,fail){wx.checkJsApi({jsApiList:["chooseWXPay"],success:function(res){if(res.checkResult.chooseWXPay){success();}else{fail();}},fail:function(){fail();}});};weiChatPayUtils.getNonceStr=function(){return Math.random().toString(36).substr(2,15);};function objToString(obj){var str="";for(var p in obj){if(obj.hasOwnProperty(p)){str+=p+"="+obj[p]+"&";}}return str.slice(0,-1);}weiChatPayUtils.getHash=function(paramsArray){var params=paramsArray.sort();var stringAllKeys=objToString(params);var stringSignTemp=stringAllKeys+"&key="+wechatConfig.appsecret;return MMUtils.hex_md5(stringSignTemp).toUpperCase();};weiChatPayUtils.getTimestamp=function(){return parseInt(new Date().getTime()/1000)+"";};weiChatPayUtils.unifiedorder=function(success,fail){var url="https://api.mch.weixin.qq.com/pay/unifiedorder";var params={appId:"wx762f832959951212",mch_id:"1233699402",nonce_str:"",sign:"",body:"",attach:"",out_trade_no:"",total_fee:"",spbill_create_ip:"",notify_url:"",trade_type:"JSAPI",openid:""};$http.post(url,params,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).success(function(data,status,headers,config){console.log(data);success(data,status,headers,config);}).error(function(data,status,headers,config){fail(data,status,headers,config);});};weiChatPayUtils.chooseWXPay=function(success,fail){var info={appId:wechatConfig.appId,timestamp:this.getTimestamp(),nonceStr:this.getNonceStr(),"package":"prepay_id=test12121212",signType:"MD5"};info.paySign=this.getHash(info);info.success=function(res){if(res.err_msg=="get_brand_wcpay_request:ok"){success(res);}else{fail(res);}};wx.chooseWXPay(info);};}).error(function(res){});return weiChatPayUtils;});