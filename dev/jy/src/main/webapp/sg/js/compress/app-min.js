var miaomiao=angular.module("miaomiao.shop",["ionic","LocalStorageModule","ngStorage","ngAnimate","pasvaz.bindonce","QuickList","ionic.rating"],function(b,a){b.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var c=function(g){var l="",d,m,h,e,j,k,f;for(d in g){m=g[d];if(m instanceof Array){for(f=0;f<m.length;++f){j=m[f];h=d+"["+f+"]";k={};k[h]=j;l+=c(k)+"&";}}else{if(m instanceof Object){for(e in m){j=m[e];h=d+"["+e+"]";k={};k[h]=j;l+=c(k)+"&";}}else{if(m!==undefined&&m!==null){l+=encodeURIComponent(d)+"="+encodeURIComponent(m)+"&";}}}}return l.length?l.substr(0,l.length-1):l;};b.defaults.transformRequest=[function(d){return angular.isObject(d)&&String(d)!=="[object File]"?c(d):d;}];});miaomiao.config(function(b,a){b.state("locate",{url:"/locate",templateUrl:"/views/sg/templates/locate.html",controller:"LoadingCtrl"}).state("findshop",{url:"/findshop",templateUrl:"/views/sg/templates/findShop.html",controller:"FindShopCtrl"}).state("productList",{url:"/productlist",templateUrl:"/views/sg/templates/productList.html",controller:"ProductCtrl"}).state("goToShop",{url:"/shop?shop_id",templateUrl:"/views/sg/templates/productList.html",controller:"GoToShopCtrl"}).state("search",{url:"/search",templateUrl:"/views/sg/templates/search.html",controller:"SearchCtrl"}).state("checkout",{url:"/checkout",templateUrl:"/views/sg/templates/checkout.html",controller:"CheckoutCtrl"}).state("addressList",{url:"/addresslist",templateUrl:"/views/sg/templates/addressList.html",controller:"AddressListCtrl"}).state("userAddressList",{url:"/useraddresslist",templateUrl:"/views/sg/templates/addressList.html",controller:"UserAddressListCtrl"}).state("myOrders",{url:"/myorders",templateUrl:"/views/sg/templates/myOrders.html",controller:"MyOrdersCtrl"});a.otherwise("/locate");}).config(function(a){a.decorator("$state",function(b,c){b.forceReload=function(){return b.go(b.current,c,{reload:true,inherit:false,notify:true});};return b;});});angular.module("miaomiao.shop").directive("backImg",function(){return function(d,c,b){var a=b.backImg;c.css({"background-image":"url("+a+")","background-size":"contain"});};}).directive("slideable",function(){return{restrict:"C",compile:function(c,b){var d=c.html();c.html('<div class="slideable_content" style="margin:0 !important; padding:0 !important" >'+d+"</div>");return function a(g,f,e){e.duration=(!e.duration)?"1s":e.duration;e.easing=(!e.easing)?"ease-in-out":e.easing;f.css({overflow:"hidden",display:"none",transitionProperty:"height",transitionDuration:e.duration,transitionTimingFunction:e.easing});};}};}).directive("slideToggle",function(){return{restrict:"A",scope:{isOpen:"=slideToggle"},link:function(d,c,a){var b=parseInt(a.slideToggleDuration,10)||200;d.$watch("isOpen",function(e,f){if(e!==f){c.stop().slideToggle(b);}});}};}).directive("bnSlideShow",function(){function a(c,d,b){var f=b.bnSlideShow;var e=(b.slideShowDuration||"fast");if(!c.$eval(f)){$(d).hide();}c.$watch(f,function(h,g){if(h===g){return;}if(h){$(d).stop(true,true).slideDown(e);}else{$(d).stop(true,true).slideUp(e);}});}return({link:a,restrict:"A"});}).directive("bnCommonShow",function(){function a(c,d,b){var e=b.bnCommonShow;if(!c.$eval(e)){$(d).hide();}c.$watch(e,function(g,f){if(g===f){return;}if(g){$(d).show();}else{$(d).hide();}});}return({link:a,restrict:"A"});});angular.module("miaomiao.shop").filter("getTotolCount",function(){return function(a){a=a||[];var b=0;for(var c=0;c<a.length;c++){b+=parseInt(a[c].count||0);}return b;};}).filter("getTotolPrice",function(){return function(a){a=a||[];var b=0;for(var c=0;c<a.length;c++){b+=parseFloat(a[c].price||0)*parseInt(a[c].count||0);}return b/100;};}).filter("removeAMPM",function(){return function(a){if(!a){return;}return a.replace(/AM/,"").replace(/PM/,"");};}).filter("getShopStatusString",function(){return function(a){return a==0?"营业中":"打烊了";};}).filter("getShopMinPrice",function(){return function(a){return a?a/100:20;};}).filter("insertSpaceForShortName",function(){return function(a){return a.length==2?a.charAt(0)+"    "+a.charAt(1):a;};});var miaomiao=angular.module("miaomiao.shop");miaomiao.factory("httpClient",["$http",function(c){var a=function(e,g,f,d){c({method:"GET",url:e+"?"+g}).success(function(j,h,k,i){f(j,h,k,i);}).error(function(j,h,k,i){d(j,h,k,i);});};var b=function(e,g,f,d){c.post(e,g,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).success(function(j,h,k,i){f(j,h,k,i);}).error(function(j,h,k,i){d(j,h,k,i);});};return{getProductList:function(e,f,d){a("shop/category/get","shop_id="+e,f,d);},getMoreProductList:function(e,h,i,g,f,d){a("shop/getitems","shop_id="+e+"&category_id="+h+"&from="+i+"&offset="+g,f,d);},getAddressList:function(e,f,d){a("address","shop_id="+e,f,d);},setDefaultAddress:function(e,g,f,d){b("address/default?shop_id="+e,{address_id:g.id,address:g.address,phone:g.phone},f,d);},addAddress:function(e,g,f,d){b("address/add?shop_id="+e,{address:g.address,phone:g.phone},f,d);},getConfirmCartList:function(f,e,g,d){b("shopCar/confirm?shop_id="+f,{items:JSON.stringify(e)},g,d);},getOrderSave:function(k,i,j,g,f,h,d,l,e){b("order/save?shop_id="+k,{items:JSON.stringify(h),address_id:i,address:j,phone:g,remarks:f,order_id:d},l,e);},getMyOrders:function(e,f,d){a("user/profile","shop_id="+e,f,d);},getSearchResults:function(f,e,g,d){a("search/query","shop_id="+f+"&key="+e,g,d);},getSearchSuggestion:function(f,e,g,d){a("/suggestion/query","shop_id="+f+"&q="+e,g,d);},getShopByGEOLocation:function(f,e,g,d){a("f","lat="+f+"&lng="+e,g,d);},getShopList:function(g,f,e,d){a("shop/shopList","from="+g+"&offset="+f,e,d);},getShopInfo:function(e,f,d){a("shop","shop_id="+e,f,d);},getNearShopList:function(f,e,g,d){a("near","lat="+f+"&lng="+e,g,d);}};}]).factory("GEOLocationService",["$timeout",function(a){return{GEOLocationSupported:function(b){return navigator.geolocation;}};}]).factory("AddressService",["$http","$rootScope","$timeout",function(c,a,b){return{addressChangeEventSwitchDefault:function(d){b(function(){a.$broadcast("MMEVENT_AddressChangeEventSwitchDefault",{item:d});});},onAddressChangeEventSwitchDefault:function(d,e){d.$on("MMEVENT_AddressChangeEventSwitchDefault",function(g,f){e(f);});},addressChangeEventAddNew:function(d){b(function(){a.$broadcast("MMEVENT_AddressChangeEventAddNew",{item:d});});},onAddressChangeEventAddNew:function(d,e){d.$on("MMEVENT_AddressChangeEventAddNew",function(g,f){e(f);});}};}]).factory("OrderService",["$http","$rootScope","$timeout",function(c,a,b){return{orderChangeEventSuccess:function(d){b(function(){a.$broadcast("MMEVENT_OrderChangeEventSuccess",{item:d});});},onOrderChangeEventSuccess:function(d,e){d.$on("MMEVENT_OrderChangeEventSuccess",function(g,f){e(f);});}};}]).factory("MMUtils",["$timeout",function(a){return{isEmptyObject:function(c){if(c==null){return true;}if(c.length>0){return false;}if(c.length===0){return true;}for(var b in c){if(Object.prototype.hasOwnProperty.call(c,b)){return false;}}return true;},isValidTelNumber:function(d){var c=/^(([0\+]\d{2,3}-)?(0\d{2,3})-)?(\d{7,8})(-(\d{3,}))?$/;var b=/^1[3|4|5|6|7|8|9][0-9]{1}[0-9]{8}$/;return c.test(d)||b.test(d);}};}]);angular.module("miaomiao.shop").factory("ShoppingCart",["$http","$rootScope","localStorageService","$localStorage","$sessionStorage","$timeout",function(f,a,d,b,e,c){return{_shoppingItems:function(){var g=e.MMMETA_SavedShoppingCartItems||[];return g;},itemExistInCart:function(i,h){for(var g=0;g<h.length;g++){if(i.id==h[g].id){return true;}}return false;},addItemToCart:function(j){var h=this._shoppingItems();var i=-1;for(var g=0;g<h.length;g++){if(j.id==h[g].id){i=g;break;}}if(i==-1){h.push(j);}else{h[i].count=j.count;}e.MMMETA_SavedShoppingCartItems=h;},removeItemFromCart:function(j){var h=this._shoppingItems();var i=-1;for(var g=0;g<h.length;g++){if(j.id==h[g].id){i=g;break;}}if(i>-1){if(j.count<=0){h.splice(i,1);}else{h[i].count=j.count;}}e.MMMETA_SavedShoppingCartItems=h;},getAllItems:function(){return this._shoppingItems();},clearAll:function(){e.MMMETA_SavedShoppingCartItems=[];this.itemChangeEventInShoppingCart();},getCountForItem:function(i){var h=this._shoppingItems();for(var g=0;g<h.length;g++){if(i.id==h[g].id){return h[g].count;}}return 0;},getCountForCategroy:function(j){var h=this._shoppingItems();var i=0;for(var g=0;g<h.length;g++){if(j==h[g].category_id){i+=h[g].count;}}return i;},getTotalCount:function(){var g=this._shoppingItems();var h=0;for(var i=0;i<g.length;i++){h+=parseInt(g[i].count||0);}return h;},getTotalPrice:function(){var g=0;var h=this._shoppingItems();for(var i=0;i<h.length;i++){g+=parseFloat(h[i].price||0)*parseInt(h[i].count||0);}return g/100;},cartReadyToShip:function(){var h=d.get("MMMETA_shop")||{},g=h.base_price||2000;return this.getTotalPrice()>=g/100;},cartNotReadyLeftPrice:function(){var h=d.get("MMMETA_shop")||{},g=h.base_price||2000;return Math.round((g/100-this.getTotalPrice())*100)/100;},itemChangeEventInShoppingCart:function(g){c(function(){a.$broadcast("MMEVENT_ItemSelectionChangedInShoppingCart",{item:g});});},onItemChangeEventInShoppingCart:function(g,h){g.$on("MMEVENT_ItemSelectionChangedInShoppingCart",function(j,i){h(i);});},itemChangeEventInProductList:function(g){c(function(){a.$broadcast("MMEVENT_ItemSelectionChangedInProductList",{item:g});});},onItemChangeEventInProductList:function(g,h){g.$on("MMEVENT_ItemSelectionChangedInProductList",function(j,i){h(i);});}};}]);angular.module("miaomiao.shop").controller("LoadingCtrl",function(k,g,i,a,e,b,d,j){k.info={};k.info.getGeolocationTitle="定位中...";k.info.getGeolocationTitleClass="blink_me";k.info.showLocateImg=true;k.info.lastShop=e.get("MMMETA_shop");function h(l){if(l){k.info.getGeolocationTitle="定位成功，正在加载请稍候...";k.info.getGeolocationTitleClass="getGeolocation-title-success";e.set("MMMETA_location_pos_ready",1);e.set("MMMETA_location_pos_data",{lat:l.coords.latitude,lng:l.coords.longitude});a.go("findshop");}else{k.info.getGeolocationTitle="定位失败...";e.set("MMMETA_location_pos_ready",0);a.go("findshop");}}function f(l){k.info.getGeolocationTitleClass="getGeolocation-title-fail";switch(l.code){case l.PERMISSION_DENIED:k.info.getGeolocationTitle="定位失败，请确认您开启位置服务";break;case l.POSITION_UNAVAILABLE:k.info.getGeolocationTitle="定位失败，请确认您开启位置服务";break;case l.TIMEOUT:k.info.getGeolocationTitle="定位超时，请您重试";break;case l.UNKNOWN_ERROR:k.info.getGeolocationTitle="定位出现未知错误，请您重试";break;default:k.info.getGeolocationTitle="定位失败，请您重试";}e.set("MMMETA_location_pos_ready",0);a.go("findshop");}function c(){if(navigator.geolocation){var l={timeout:10000};navigator.geolocation.getCurrentPosition(h,f,l);}else{k.info.showLocateImg=false;k.info.getGeolocationTitle="您的浏览器不支持定位！";e.set("MMMETA_location_pos_ready",0);a.go("findshop");}}k.$on("$ionicView.enter",function(){if(k.info.lastShop&&k.info.lastShop.id){a.go("productList");}else{b(function(){c();},1000);}});});angular.module("miaomiao.shop").controller("FindShopCtrl",function(m,k,a,h,j,g,e,l,c){m.shop_data={};m.shop_items=[];m.shop_info={};m.shop_info.showShopList=false;m.shop_info.showShopHistory=false;m.shop_info.showAddressSuggestion=false;m.shop_info.locationReady=g.get("MMMETA_location_pos_ready");if(!m.shop_info.locationReady){m.shop_info.locationMessage="定位失败,您可以搜索你所在的小区";}else{m.shop_info.locationMessage="定位成功，正在加载地址...";}m.shop_history=g.get("MMMETA_shop_history")||[];if(m.shop_history.length){m.shop_info.showShopHistory=true;}m.clearSearch=function(){m.shop_data.searchQuery="";m.shop_info.startSearch=false;b();};function f(){m.shop_info.showAddressSuggestion=true;m.shop_info.showShopList=false;m.shop_info.showShopHistory=false;}function b(){m.shop_info.showAddressSuggestion=false;m.shop_info.showShopList=true;if(m.shop_history.length){m.shop_info.showShopHistory=true;}}m.startSearch=function(){m.shop_info.startSearch=true;f();};m.goToShop=function(o){if(o.status!=undefined&&o.status!=0){return;}var p=false;for(var n=0;n<m.shop_history.length;n++){if(o.id==m.shop_history[n].id){p=true;break;}}if(!p){m.shop_history.push(o);}g.set("MMMETA_shop_history",m.shop_history);g.set("MMMETA_shop",o);if(m.modal){m.modal.hide();}else{a.go("productList",null,{reload:true});}};m.readonly=true;m.getSuggestions=function(q,o){m.shop_info.isGettingSuggestions=true;var n={onSearchComplete:function(s){if(p.getStatus()==BMAP_STATUS_SUCCESS){var t=[];for(var r=0;r<s.getCurrentNumPois();r++){t.push({title:s.getPoi(r).title,address:s.getPoi(r).address});}c(function(){m.shop_info.address_suggestions=t;});}m.shop_info.isGettingSuggestions=false;}};var p=new BMap.LocalSearch("北京市",n);p.search(q);};m.goToSearchAddress=function(n){c(function(){m.shop_info.locationMessage=n.title;});m.performSearch(n.title);};m.performSearch=function(p,o){if(o){o.target.blur();}var n=p||m.shop_data.searchQuery;c(function(){m.shop_info.locationMessage=n;m.shop_info.startSearch=false;});m.LoadingMessage="正在搜索"+n+"附近的店...";j.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:m});var q=new BMap.Geocoder();q.getPoint(n,function(r){if(r){e.getNearShopList(r.lat,r.lng,function(w,s){j.hide();var u=w.code,v=w.data;if(u==0&&!l.isEmptyObject(v)){m.shop_items=v.shops;for(var t=0;t<m.shop_items.length;t++){m.shop_items[t].rate=5;m.shop_items[t].maxRate=5;}}else{m.shop_items=[];}b();},function(t,s){j.hide();b();});}else{j.hide();b();}},"北京市");};m.relocation=function(){function o(q){j.hide();if(q){c(function(){m.shop_info.locationMessage="定位成功,正在获取地址...";});g.set("MMMETA_location_pos_ready",1);g.set("MMMETA_location_pos_data",{lat:q.coords.latitude,lng:q.coords.longitude});i();}else{c(function(){m.shop_info.locationMessage="定位失败！";});}}function n(){j.hide();c(function(){m.shop_info.locationMessage="定位失败！";});}if(navigator.geolocation){var p={timeout:10000};m.LoadingMessage="正在重新定位...";j.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:m});navigator.geolocation.getCurrentPosition(o,n,p);}else{m.shop_info.locationMessage="浏览器不支持定位";}};function d(n,o){var p=new BMap.Geocoder();p.getLocation(new BMap.Point(n,o),function(q){if(q){g.set("MMMETA_location_pos_addr",q.address);c(function(){m.shop_info.locationMessage=q.address;});}});}function i(){m.shop_info.locationReady=g.get("MMMETA_location_pos_ready");if(m.shop_info.locationReady){m.shop_info.locationData=g.get("MMMETA_location_pos_data");d(m.shop_info.locationData.lng,m.shop_info.locationData.lat);e.getNearShopList(m.shop_info.locationData.lat,m.shop_info.locationData.lng,function(q,n){var o=q.code,p=q.data;if(o==0||!l.isEmptyObject(p)){c(function(){m.shop_items=p.shops;for(var r=0;r<m.shop_items.length;r++){m.shop_items[r].rate=5;m.shop_items[r].maxRate=5;}m.shop_info.showAddressSuggestion=false;m.shop_info.showShopList=true;});}},function(o,n){c(function(){m.shop_info.showAddressSuggestion=false;m.shop_info.showShopList=true;});});}}c(function(){i();});m.$on("$ionicView.enter",function(){m.shop_info.showShopList=false;m.shop_info.showShopHistory=false;m.shop_info.showAddressSuggestion=false;if(m.shop_history.length){m.shop_info.showShopHistory=true;}if(m.shop_items.length){m.shop_info.showShopList=true;}});});angular.module("miaomiao.shop").controller("ProductCtrl",function(n,g,k,h,j,d,t,u,r,s,f,o,e,i){n.shop=f.get("MMMETA_shop");if(!n.shop){j.alert({title:"加载店铺失败,请重新选择店铺",template:""});r.go("findshop");return;}n.info={};n.currentDisplayCategory={};n.currentDisplayItems=[];n.categoryls=[];function b(){n.LoadingMessage="正在加载商品 ...";h.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:n,noBackdrop:true});o.getProductList(n.shop.id,function(A,w){h.hide();var y=A.code,z=A.data;if(!y==0){j.alert({title:"加载数据失败",template:""});return;}n.shop=z.shop;if(n.shop){f.set("MMMETA_shop",n.shop);}n.categoryls=z.categoryls;for(var v=0;v<n.categoryls.length;v++){n.categoryls[v].totalCnt=e.getCountForCategroy(n.categoryls[v].category_id);n.categoryls[v].selected=0;n.categoryls[v].canLoadMore=1;if(v==0){n.categoryls[v].selected=1;}if(n.categoryls[v].name.length==2){n.categoryls[v].name=n.categoryls[v].name.charAt(0)+"  "+n.categoryls[v].name.charAt(1);}for(var B=0;B<n.categoryls[v].itemls.length;B++){var x=n.categoryls[v].itemls[B];x.count=e.getCountForItem(x);}}n.currentDisplayCategory=n.categoryls.length&&n.categoryls[0];n.currentDisplayItems=n.currentDisplayCategory&&n.currentDisplayCategory.itemls;},function(w,v){h.hide();j.alert({title:"加载数据失败",template:""});return;});}s(function(){b();});var l=true,p=false;n.selectCategory=function(w){if(p){return;}for(var v=0;v<n.categoryls.length;v++){n.categoryls[v].selected=0;}w.selected=1;n.currentDisplayCategory=w;n.currentDisplayItems=w.itemls;t.$getByHandle("productScroll").scrollTop();};n.moreDataCanBeLoaded=function(){return n.currentDisplayCategory.canLoadMore;};n.addItems=function(){var w=n.currentDisplayCategory.category_id,x=n.currentDisplayItems.length,v=20;p=true;o.getMoreProductList(n.shop.id,w,x,v,function(C,y){var A=C.code,B=C.data;if(!A==0||B.items.length==0){n.currentDisplayCategory.canLoadMore=false;p=false;return;}for(var D=0;D<B.items.length;D++){var z=B.items[D];z.count=e.getCountForItem(z);}n.currentDisplayItems=n.currentDisplayItems.concat(B.items);n.currentDisplayCategory.totalCnt=e.getCountForCategroy(n.currentDisplayCategory.category_id);p=false;n.$broadcast("scroll.infiniteScrollComplete");},function(z,y){p=false;n.currentDisplayCategory.canLoadMore=false;n.$broadcast("scroll.infiniteScrollComplete");});};function a(){s(function(){n.info.shoppingCartItems=e.getAllItems();n.info.cartReadyToShip=e.cartReadyToShip();n.info.checkoutHintMessage=n.info.cartReadyToShip?"去结算":"差 "+e.cartNotReadyLeftPrice()+" 元起送";});}n.selectItem=function(v){v.count+=1;n.currentDisplayCategory.totalCnt+=1;e.addItemToCart(v);a();e.itemChangeEventInProductList(v);};n.removeItem=function(w,v){w.count-=1;w.count=w.count<=0?0:w.count;e.removeItemFromCart(w);a();e.itemChangeEventInProductList(w);n.currentDisplayCategory.totalCnt-=1;n.currentDisplayCategory.totalCnt=n.currentDisplayCategory.totalCnt>=0?n.currentDisplayCategory.totalCnt:0;};n.checkout=function(){f.set("MMMETA_shop",n.shop);if(!n.info.cartReadyToShip){return;}r.go("checkout",null,{reload:true});};n.goToSearch=function(){r.go("search",null,{reload:true});};n.showShoppingCart=function(){n.info.showCart=!n.info.showCart;};d.fromTemplateUrl("/views/sg/templates/switchShop.html",{scope:n,animation:"slide-in-up"}).then(function(v){n.modal=v;});n.switchShop=function(){n.modal.show();};n.$on("modal.hidden",function(){var v=f.get("MMMETA_shop");if(v.id!=n.shop.id){s(function(){n.shop=v;});q();e.clearAll();a();s(function(){b();});}});d.fromTemplateUrl("/views/sg/templates/productPreview.html",{scope:n,animation:"slide-in-up"}).then(function(v){n.previewModal=v;});n.openPreviewModal=function(){n.previewModal.show();};n.closePreviewModal=function(){n.previewModal.remove();};n.showImage=function(v){n.imageSrc=v.pic_url;d.fromTemplateUrl("/views/sg/templates/productPreview.html",{scope:n,animation:"slide-in-up"}).then(function(w){n.previewModal=w;n.openPreviewModal();});};function m(){if(!n.categoryls){return;}for(var v=0;v<n.categoryls.length;v++){n.categoryls[v].totalCnt=e.getCountForCategroy(n.categoryls[v].category_id);for(var w=0;w<n.categoryls[v].itemls.length;w++){var x=n.categoryls[v].itemls[w];x.count=e.getCountForItem(x);}}a();}function c(w){if(!n.categoryls){return;}for(var v=0;v<n.categoryls.length;v++){if(n.categoryls[v].category_id==w.category_id){n.categoryls[v].totalCnt=e.getCountForCategroy(n.categoryls[v].category_id);for(var x=0;x<n.categoryls[v].itemls.length;x++){var y=n.categoryls[v].itemls[x];if(y.id==w.id){y.count=e.getCountForItem(y);}}break;}}a();}e.onItemChangeEventInShoppingCart(n,function(w){var v=w.item;if(v){c(v);}else{m();}});function q(){var v=f.get("MMMETA_shop");s(function(){n.shop=v;});o.getShopInfo(v.id,function(A,w){var y=A.code,z=A.data;if(z.shop&&z.shop.status!=0){var x=j.alert({title:z.shop.name+"打烊啦，去其他店铺看看？",template:""});x.then(function(B){r.go("findshop",null,{reload:true});return;});}},function(x,w){});}n.$on("$ionicView.enter",function(){q();a();m();if(!n.currentDisplayItems||!n.currentDisplayItems.length){s(function(){b();});}});});angular.module("miaomiao.shop").controller("GoToShopCtrl",function(o,l,k,c,h,b,m,e,j,a,d,g,f,n,i){o.LoadingMessage="正在加载店铺信息 ...";h.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:o,noBackdrop:true});f.getShopInfo(l.shop_id,function(s,p){h.hide();var q=s.code,r=s.data;if(!q==0){b.alert({title:"加载数据失败",template:""});return;}o.shop=r.shop;g.set("MMMETA_shop",o.shop);a.go("productList",null,{reload:true});},function(q,p){b.alert({title:"加载店铺信息失败，请刷新",template:""});return;});});angular.module("miaomiao.shop").controller("SearchCtrl",function(l,j,g,d,b,i,a,c,f,e,k){l.shop=f.get("MMMETA_shop")||{};l.info={};l.performSearch=function(o,n){n.target.blur();var m=o||l.info.key;l.LoadingMessage="正在搜索...";g.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:l});l.info.showSearchSuggestion=false;l.info.showSearchResult=true;e.getSearchResults(l.shop.id,m,function(t,p){g.hide();var r=t.code,s=t.data;if(!r==0||s.length==0){l.searchResultsItems=[];l.info.hasNoResults=true;return;}l.info.hasNoResults=false;for(var u=0;u<s.length;u++){var q=s[u];q.count=k.getCountForItem(q);}l.searchResultsItems=s;d.$getByHandle("searchResultScroll").scrollTop();},function(q,p){g.hide();l.info.hasNoResults=true;});};l.getSearchSuggestions=function(){e.getSearchSuggestion(l.shop.id,l.info.key,function(p,m){var n=p.code,o=p.data;c(function(){l.info.search_suggestions=o;});},function(n,m){});};l.goToSearchItem=function(n,m){l.info.showSearchSuggestion=false;l.info.showSearchResult=true;m.stopPropagation();l.performSearch(n.key,m);};function h(){c(function(){l.info.shoppingCartItems=k.getAllItems();l.info.cartReadyToShip=k.cartReadyToShip();l.info.checkoutHintMessage=l.info.cartReadyToShip?"去结算":"差 "+k.cartNotReadyLeftPrice()+" 元起送";});}h();l.selectItem=function(m){m.count+=1;k.addItemToCart(m);h();k.itemChangeEventInProductList(m);};l.removeItem=function(n,m){n.count-=1;n.count=n.count<=0?0:n.count;k.removeItemFromCart(n);h();k.itemChangeEventInProductList(n);};l.startSearch=function(){l.info.showSearchSuggestion=true;l.info.showSearchResult=false;};l.clearSearch=function(){l.info.key="";l.info.showSearchSuggestion=true;l.info.showSearchResult=false;};l.checkout=function(){a.go("checkout",null,{reload:true});};l.showShoppingCart=function(){l.info.showCart=!l.info.showCart;};k.onItemChangeEventInShoppingCart(l,function(n){var m=n.item;h();for(var o=0;o<l.searchResultsItems.length;o++){var m=l.searchResultsItems[o];m.count=k.getCountForItem(m);}});});angular.module("miaomiao.shop").controller("CheckoutCtrl",function(p,l,c,g,b,k,a,f,d,o,h,j,n){p.shoppingCartItems=o.getAllItems();p.shop=f.get("MMMETA_shop");p.info={};p.info.address={};p.info.newOrderAddress="";p.info.newOrderPhone="";function e(){p.info.remarks="";p.LoadingMessage="正在核对,请稍候...";g.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:p});d.getConfirmCartList(p.shop.id,o.getAllItems(),function(w,q){g.hide();var u=w.code,v=w.data;if(u==500){b.alert({title:"加载数据失败:"+w.msg,template:""});return;}else{if(u==100){b.alert({title:"部分商品不足，请谨慎购买:"+w.msg,template:""});}}p.shop=v.shop;for(var s=0;s<v.itemls.length;s++){var t=v.itemls[s];for(var r=0;r<p.shoppingCartItems.length;r++){if(t.id==p.shoppingCartItems[r].id){if(t.info){p.shoppingCartItems[r].message=t.info;}}}}p.addressls=v.addressls;p.info.address=p.addressls&&p.addressls.length&&p.addressls[0];if(!p.info.address){p.info.showAddNewAddress=true;}},function(r,q){g.hide();});}p.goToAddressList=function(){a.go("addressList",null,{reload:true});};p.goback=function(){a.go("productList",null,{reload:true});};p.cartReadyToShip=o.cartReadyToShip();p.selectItem=function(q){q.count+=1;o.itemChangeEventInShoppingCart(q);i();};p.removeItem=function(r,q){r.count-=1;if(r.count<=0){r.count=0;o.removeItemFromCart(r);}o.itemChangeEventInShoppingCart(r);i();};p.confirmCheckout=function(){if(!p.cartReadyToShip){return;}if(p.addressls&&p.addressls.length){p.info.address=p.addressls[0];}else{p.info.address={id:"",address:p.info.newOrderAddress,phone:p.info.newOrderPhone};if(!p.info.newOrderAddress||!p.info.newOrderPhone||!n.isValidTelNumber(p.info.newOrderPhone)){b.alert({title:"请填写正确的地址电话",template:""});return;}p.addressls=p.addressls||[];p.addressls[0]=p.info.address;p.info.showAddNewAddress=false;}p.LoadingMessage="正在生成订单,请稍候...";g.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:p});d.getOrderSave(p.shop.id,p.info.address.id,p.info.address.address,p.info.address.phone,p.info.remarks||"",p.shoppingCartItems,p.info.order_id,function(t,q){g.hide();var r=t.code,s=t.data;if(r==500){b.alert({title:"生成订单失败，请重新购买:"+t.msg,template:""});return;}else{if(r==100){b.alert({title:"部分商品不足，请重新购买:"+t.msg,template:""});return;}}o.clearAll();i();a.go("myOrders",null,{reload:true});},function(r,q){g.hide();b.alert({title:"生成订单失败，请重新购买:"+r.msg,template:""});});};function m(q){if(q){p.addressls=p.addressls||[];p.addressls[0]=q;p.info.address=p.addressls[0];}else{p.LoadingMessage="正在更新地址...";g.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:p});d.getAddressList(p.shop.id,function(u,r){var s=u.code,t=u.data;if(s!=0){b.alert({title:"加载数据失败:"+u.msg,template:""});return;}g.hide();p.addressls=t.addressls||[];},function(s,r){p.addressls=[];b.alert({title:"加载数据失败,请重试",template:""});});}}function i(){c(function(){p.shoppingCartItems=o.getAllItems();p.cartReadyToShip=o.cartReadyToShip();p.checkoutHintMessage=p.cartReadyToShip?"货到付款":"差 "+o.cartNotReadyLeftPrice()+" 元起送";});}h.onAddressChangeEventSwitchDefault(p,function(q){m(q.item);});h.onAddressChangeEventAddNew(p,function(q){m(q.item);});j.onOrderChangeEventSuccess(p,function(){i();});p.$on("$ionicView.enter",function(){i();e();});});angular.module("miaomiao.shop").controller("AddressListCtrl",function(j,f,h,b,c,e,d,g,i){j.shop=e.get("MMMETA_shop");function a(){j.LoadingMessage="正在加载地址列表...";f.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:j});d.getAddressList(j.shop.id,function(n,k){var l=n.code,m=n.data;if(l!=0){c.alert({title:"加载数据失败:"+n.msg,template:""});return;}f.hide();j.shop=m.shop;j.addressls=m.addressls||[];if(j.addressls&&j.addressls.length){j.addressls[0].isDefault=true;}},function(l,k){j.addressls=[];c.alert({title:"加载数据失败,请刷新",template:""});});}j.goToAddNewAddress=function(){b.go("addAddress");};j.setDefaultAddress=function(l){for(var k=0;k<j.addressls.length;k++){j.addressls[k].isDefault=false;}l.isDefault=true;j.LoadingMessage="正在切换默认地址...";f.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:j});d.setDefaultAddress(j.shop.id,l,function(p,m){var n=p.code,o=p.data;if(n!=0){c.alert({title:"切换默认地址:"+p.msg,template:""});return;}f.hide();b.go("checkout",null,{reload:true});g.addressChangeEventSwitchDefault(l);},function(n,m){f.hide();c.alert({title:"加载数据失败,请刷新",template:""});});};j.addNewAddressConfirm=function(){if(!j.newAddress.address||!j.newAddress.phone||!i.isValidTelNumber(j.newAddress.phone)){c.alert({title:"请填写正确的地址电话",template:""});return;}j.LoadingMessage="正在添加新地址...";f.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:j});d.addAddress(j.shop.id,j.newAddress,function(n,k){var l=n.code,m=n.data;if(l!=0){c.alert({title:"添加新地址失败:"+n.msg,template:""});return;}f.hide();b.go("checkout",null,{reload:true});g.addressChangeEventAddNew(j.newAddress);},function(l,k){f.hide();c.alert({title:"添加新地址失败,请刷新",template:""});});};j.$on("$ionicView.enter",function(){j.newAddress={};a();});});angular.module("miaomiao.shop").controller("ProductDetailCtrl",["$scope","$ionicModal",function(b,a){a.fromTemplateUrl("/views/sg/templates/productPreview.html",{scope:b,animation:"slide-in-up"}).then(function(c){b.modal=c;});b.openModal=function(){b.modal.show();};b.closeModal=function(){b.modal.hide();};b.$on("$destroy",function(){b.modal.remove();});b.$on("modal.hide",function(){});b.$on("modal.removed",function(){});b.$on("modal.shown",function(){});b.imageSrc="http://ionicframework.com/img/ionic-logo-blog.png";b.showImage=function(c){b.imageSrc=c.pic_url;b.openModal();};}]);angular.module("miaomiao.shop").controller("MyOrdersCtrl",function(m,f,b,j,a,c,e,k,d,h,i,l){m.shop=e.get("MMMETA_shop")||{};m.goToAddressList=function(){a.go("userAddressList",null,{reload:true});};m.backToHome=function(){a.go("productList");};function g(q){if(!q){return;}for(var p=0;p<q.length;p++){var o=q[p];try{o.items=JSON.parse(o.snapshot);}catch(r){}}}m.info={};m.info.hasShop=m.shop&&m.shop.id!=null;m.addr={};m.addressls=k.MMMETA_OrderAddresses||[];m.orders=k.MMMETA_OrderOrders||[];g(m.orders);function n(o){if(o){m.addressls=m.addressls||[];m.addressls[0]=o;m.info.address=m.addressls[0];}else{m.LoadingMessage="正在加载,请稍候...";f.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:m});m.info.hasShop=m.shop&&m.shop.id!=null;d.getMyOrders(m.shop.id,function(s,p){f.hide();var q=s.code,r=s.data;m.shop=r.shop;m.addressls=r.addressls;m.info.hasAddress=m.addressls.length>0?true:false;m.orders=r.orders;g(m.orders);m.info.hasOrder=m.orders.length>0?true:false;k.orderAddresses=m.addressls;k.orderOrders=m.orders;c.resize();},function(q,p){m.info.hasOrder=false;m.info.hasAddress=false;c.resize();f.hide();});}}m.addNewAddressInOrderPage=function(){if(!m.addr.address||!m.addr.phone||!l.isValidTelNumber(m.addr.phone)){b.alert({title:"请填写正确的地址电话",template:""});return;}m.LoadingMessage="正在添加新地址...";f.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:m});var o=m.shop&&m.shop.id||1;d.addAddress(o,m.addr,function(s,p){var q=s.code,r=s.data;if(q!=0){b.alert({title:"添加新地址失败:"+s.msg,template:""});return;}f.hide();h.addressChangeEventAddNew(m.addr);c.resize();a.go("myOrders",null,{reload:true});},function(q,p){f.hide();b.alert({title:"添加新地址失败,重试",template:""});c.resize();});};m.switchToAddressList=function(o){o.target.blur();o.stopPropagation();a.go("userAddressList",null,{reload:true});};m.goToShopOrFindShop=function(){var o=e.get("MMMETA_shop");if(o&&o.id){a.go("productList",null,{reload:true});}else{a.go("findshop",null,{reload:true});}};i.orderChangeEventSuccess();h.onAddressChangeEventSwitchDefault(m,function(o){n(o.item);});h.onAddressChangeEventAddNew(m,function(o){n(o.item);});m.$on("$ionicView.enter",function(){m.shop=e.get("MMMETA_shop")||{};n();});});angular.module("miaomiao.shop").controller("ShoppingCartCtrl",function(a,d,f,b,c,e){a.info=a.info||{};a.info.shoppingCartItems=e.getAllItems();a.selectItem=function(g){g.count+=1;e.itemChangeEventInShoppingCart(g);};a.removeItem=function(h,g){h.count-=1;if(h.count<=0){h.count=0;e.removeItemFromCart(h);}e.itemChangeEventInShoppingCart(h);};a.clearShoppingCart=function(){a.info.shoppingCartItems=[];e.clearAll();};e.onItemChangeEventInProductList(a,function(g){a.info.shoppingCartItems=e.getAllItems();});});angular.module("miaomiao.shop").controller("UserAddressListCtrl",function(k,g,c,i,d,b,f,e,h,j){k.shop=f.get("MMMETA_shop")||{};function a(){k.LoadingMessage="正在加载地址列表...";g.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:k});e.getAddressList(k.shop.id,function(o,l){var m=o.code,n=o.data;if(m!=0){c.alert({title:"加载数据失败:"+o.msg,template:""});return;}g.hide();k.shop=n.shop;k.addressls=n.addressls||[];if(k.addressls&&k.addressls.length){k.addressls[0].isDefault=true;}},function(m,l){k.addressls=[];c.alert({title:"加载数据失败,请刷新",template:""});});}k.goToAddNewAddress=function(){b.go("userAddAddress");};k.setDefaultAddress=function(m){for(var l=0;l<k.addressls.length;l++){k.addressls[l].isDefault=false;}m.isDefault=true;k.LoadingMessage="正在切换默认地址...";g.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:k});e.setDefaultAddress(k.shop.id,m,function(q,n){var o=q.code,p=q.data;if(o!=0){c.alert({title:"切换默认地址:"+q.msg,template:""});return;}g.hide();h.addressChangeEventSwitchDefault(m);b.go("myOrders",null,{reload:true});},function(o,n){g.hide();c.alert({title:"加载数据失败,请刷新",template:""});});};k.addNewAddressConfirm=function(){if(!k.newAddress.address||!k.newAddress.phone||!j.isValidTelNumber(k.newAddress.phone)){c.alert({title:"请填写正确的地址电话",template:""});return;}k.LoadingMessage="正在添加新地址...";g.show({templateUrl:"/views/sg/templates/loadingIndicator.html",scope:k});e.addAddress(k.shop.id,k.newAddress,function(o,l){var m=o.code,n=o.data;if(m!=0){c.alert({title:"添加新地址失败:"+o.msg,template:""});return;}g.hide();h.addressChangeEventAddNew(k.newAddress);b.go("myOrders",null,{reload:true});},function(m,l){g.hide();c.alert({title:"添加新地址失败,请刷新",template:""});});};k.$on("$ionicView.enter",function(){k.newAddress={};a();});});