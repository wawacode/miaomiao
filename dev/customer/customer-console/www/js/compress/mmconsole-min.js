ionic.Config=ionic.Config||{};ionic.Config.app_id="d7255abe";ionic.Config.api_write_key="d7255abe";angular.module("miaomiao.console",["ngAnimate","ionic","ngCordova","LocalStorageModule","ngStorage","pasvaz.bindonce","QuickList","angular-datepicker","miaomiao.console.controllers","miaomiao.console.services","miaomiao.console.directives","ionic.services.deploy"]).constant("serverInfo",{host:"http://www.mbianli.com:8088",context:"/console/api/"}).config(function($httpProvider,$provide){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var param=function(obj){var query="",name,value,fullSubName,subName,subValue,innerObj,i;for(name in obj){value=obj[name];if(value instanceof Array){for(i=0;i<value.length;++i){subValue=value[i];fullSubName=name+"["+i+"]";innerObj={};innerObj[fullSubName]=subValue;query+=param(innerObj)+"&"}}else{if(value instanceof Object){for(subName in value){subValue=value[subName];fullSubName=name+"["+subName+"]";innerObj={};innerObj[fullSubName]=subValue;query+=param(innerObj)+"&"}}else{if(value!==undefined&&value!==null){query+=encodeURIComponent(name)+"="+encodeURIComponent(value)+"&"}}}}return query.length?query.substr(0,query.length-1):query};$httpProvider.defaults.transformRequest=[function(data){return angular.isObject(data)&&String(data)!=="[object File]"?param(data):data}]}).config(function($compileProvider){$compileProvider.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|tel):/)}).config(function($stateProvider,$urlRouterProvider,$ionicAppProvider,$compileProvider,$ionicConfigProvider){try{$ionicAppProvider.identify({app_id:ionic.Config.app_id})}catch(e){console.error("ionic.Config not set. Make sure config.js is loaded",e)}$compileProvider.debugInfoEnabled(false);$ionicConfigProvider.tabs.position("bottom");$ionicConfigProvider.tabs.style("standard");$stateProvider.state("signin",{url:"/sign-in",templateUrl:"templates/sign-in.html",controller:"SignInCtrl"}).state("forgotpassword",{url:"/forgot-password",templateUrl:"templates/forgot-password.html"}).state("changepassword",{url:"/change-password",templateUrl:"templates/change-password.html",controller:"ChangePwdCtrl"}).state("tab",{url:"/tab","abstract":true,templateUrl:function(){if(ionic.Platform.isAndroid()){return"templates/tabs-android.html"}return"templates/tabs.html"}}).state("tab.front-page",{url:"/front-page",views:{"tab-front-page":{templateUrl:"templates/tab-home.html",controller:"FrontPageCtrl"}}}).state("tab.shop-edit",{url:"/shop-edit",views:{"tab-front-page":{templateUrl:"templates/shop-edit.html",controller:"EditShopCtrl"}}}).state("tab.product",{url:"/product",views:{"tab-product":{templateUrl:"templates/tab-product.html",controller:"ProductCtrl"}}}).state("tab.order",{url:"/order",views:{"tab-order":{templateUrl:"templates/tab-order.html",controller:"OrderCtrl"}}}).state("tab.search",{url:"/search",views:{"tab-search":{templateUrl:"templates/tab-search.html",controller:"SearchCtrl"}}});$urlRouterProvider.otherwise("/sign-in")}).run(function($ionicPlatform,$http,$ionicDeploy,localStorageService,httpClient,$state){$ionicPlatform.ready(function(){if(window.StatusBar){StatusBar.styleLightContent()}if(window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard){cordova.plugins.Keyboard.hideKeyboardAccessoryBar(false);cordova.plugins.Keyboard.disableScroll(true)}$ionicDeploy.initialize(ionic.Config.app_id);$ionicDeploy.check().then(function(response){console.log("got a response",response);if(response){console.log("downloading updates");$ionicDeploy.download().then(function(){console.log("extracting updates");$ionicDeploy.extract().then(function(){console.log("update extracted, loading")},function(error){console.log("error extracting")},function(progress){console.log("extraction progress",progress)})},function(error){console.log("error downloading")},function(progress){console.log("progress downloading",progress)})}else{console.log("no update, loading");$ionicDeploy.load()}},function(error){console.log("[check for update] error: checking for update")});if(navigator.splashscreen){navigator.splashscreen.hide()}var user=localStorageService.get("MMCONSOLE_METADATA_USER")||{};if(!user||!user.token){return}httpClient.islogin(user.token,function(data,status){if(navigator.splashscreen){navigator.splashscreen.hide()}var code=data.code,dataDetail=data.data;if(code!=0){console.log("[check for login]check login status failed:"+code);$state.go("signin",null,{reload:true});return}localStorageService.set("MMCONSOLE_METADATA_SHOP_LIST",dataDetail.shop);localStorageService.set("MMCONSOLE_METADATA_DEFAULT_SHOP",dataDetail.shop[0]);$state.go("tab.front-page",null,{reload:true})},function(data,status){if(navigator.splashscreen){navigator.splashscreen.hide()}console.log("[check for login]check login status failed");$state.go("signin",null,{reload:true})})})});angular.module("miaomiao.console.services",[]).factory("MMPushNotification",["$rootScope","httpClient","localStorageService","$cordovaToast","$timeout",function($rootScope,httpClient,localStorageService,$cordovaToast,$timeout){return{subscribe:function(){var token=localStorageService.get("MMCONSOLE_META_PUSH_DEVICE_TOKEN");var user=localStorageService.get("MMCONSOLE_METADATA_USER");if(token&&user&&user.phone){var chn="iOS";if(ionic.Platform.isAndroid()){chn="adr";}httpClient.subscribeForCurrentDevice(user.phone,chn,token,function(){console.log("注册通知成功，您将会在此应用中收到新订单通知~");},function(){});}},newOrderNotificationReceived:function(data){console.log("we have see new orders and sent broadcast");$timeout(function(){$rootScope.$broadcast("MMEVENT_NewOrderNotificationReceived",{data:data});});},onNewOrderNotificationReceived:function($scope,handler){console.log("we watch new orders and listening for notifications");$scope.$on("MMEVENT_NewOrderNotificationReceived",function(event,message){handler(message);});}};}]).factory("MMShopService",["$rootScope","httpClient","localStorageService","$timeout",function($rootScope,httpClient,localStorageService,$timeout){return{switchDefaultShopNotification:function(data){$timeout(function(){$rootScope.$broadcast("MMEVENT_switchDefaultShopNotification",{data:data});});},onSwitchDefaultShopNotification:function($scope,handler){$scope.$on("MMEVENT_switchDefaultShopNotification",function(event,message){handler(message);});}};}]).factory("MMProductService",["$rootScope","$timeout",function($rootScope,$timeout){var categorys=[],category_summary=[],inLoadingMoreProcess=false;return{initCategorysWithData:function(cates){var retCategoryls=cates;if(!retCategoryls||!retCategoryls.length){categorys.itemls=[];return;}var retCategorylNames=[];for(var idx=0;idx<retCategoryls.length;idx++){var curCategory=retCategoryls[idx];retCategorylNames.push({name:curCategory.name,category_id:curCategory.category_id});curCategory.selected=0;curCategory.scrollIndex=curCategory.itemls.length;curCategory.canLoadMore=true;curCategory.itemls=this.removeDuplicateItems(curCategory.itemls);}categorys=retCategoryls;category_summary=retCategorylNames;},removeDuplicateItems:function(source){var arr={};for(var i=0;i<source.length;i++){arr[source[i]["id"]]=source[i];}var result=new Array();for(var key in arr){result.push(arr[key]);}return result;},setCanLoadMoreFlagForIndex:function(index,canLoadMore){categorys[index].canLoadMore=canLoadMore;},getCanLoadMoreFlagForIndex:function(index){return categorys[index].canLoadMore;},setInLoadingMoreFlag:function(inLoading){inLoadingMoreProcess=inLoading;},getInLoadingMoreFlag:function(inLoading){return inLoadingMoreProcess;},getCategorySummary:function(){return category_summary;},getCategoryForIndex:function(index){if(index<0||index>categorys.length-1){return null;}return categorys[index];},setCategoryForIndex:function(index,category){if(index<0||index>categorys.length-1){return;}categorys[index]=category;},addMoreItemsForCategoryId:function(cateId,items){for(var idx=0;idx<categorys.length;idx++){if(cateId==categorys[idx].category_id){var currentCategory=categorys[idx];currentCategory.itemls=this.removeDuplicateItems(currentCategory.itemls.concat(items));currentCategory.scrollIndex+=items.length;currentCategory.totalCnt=0;break;}}},addProductItemToCategory:function(cateId,item){for(var idx=0;idx<categorys.length;idx++){if(cateId==categorys[idx].category_id){categorys[idx].itemls.push(item);break;}}},addProductToCategoryNotification:function(cateId,item){$timeout(function(){$rootScope.$broadcast("MMEVENT_addProductToCategoryNotification",{cateId:cateId,item:item});});},onAddProductToCategoryNotification:function($scope,handler){$scope.$on("MMEVENT_addProductToCategoryNotification",function(event,message){handler(message);});},switchCategoryNotification:function(data){$timeout(function(){$rootScope.$broadcast("MMEVENT_switchCategoryNotification",{data:data});});},onSwitchCategoryNotification:function($scope,handler){$scope.$on("MMEVENT_switchCategoryNotification",function(event,message){handler(message);});},renderDataNotification:function(data){$timeout(function(){$rootScope.$broadcast("MMEVENT_renderDataNotification",{data:data});});},onRenderDataNotification:function($scope,handler){$scope.$on("MMEVENT_renderDataNotification",function(event,message){handler(message);});}};}]).factory("Camera",["$q",function($q){return{getPicture:function(options){var q=$q.defer();navigator.camera.getPicture(function(result){q.resolve(result);},function(err){q.reject(err);},options);return q.promise;}};}]).factory(("ionPlatform"),function($q){var ready=$q.defer();ionic.Platform.ready(function(device){ready.resolve(device);});return{ready:ready.promise};});angular.module("miaomiao.console.services").factory("httpClient",["$http","serverInfo",function($http,serverInfo){var doGet=function(path,params,success,fail){$http({method:"GET",url:serverInfo.host+serverInfo.context+path+"?"+params}).success(function(data,status,headers,config){success(data,status,headers,config);}).error(function(data,status,headers,config){fail(data,status,headers,config);});};var doPost=function(path,params,success,fail){$http.post(serverInfo.host+serverInfo.context+path,params,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).success(function(data,status,headers,config){success(data,status,headers,config);}).error(function(data,status,headers,config){fail(data,status,headers,config);});};return{islogin:function(token,success,fail){doGet("login/islogin","token="+token,success,fail);},login:function(phone,pwd,success,fail){doPost("login/valid",{phone:phone,pwd:pwd},success,fail);},logOut:function(phone,success,fail){doGet("logout","phone="+phone,success,fail);},changePwd:function(phone,old_pwd,new_pwd,success,fail){doPost("login/change_pwd",{phone:phone,old_pwd:old_pwd,new_pwd:new_pwd},success,fail);},getSummary:function(shopId,beginDate,endDate,success,fail){doGet("order/summary","shop_id="+shopId+"&beginDate="+beginDate+"&endDate="+endDate,success,fail);},getProductList:function(shopId,success,fail){doGet("shop/category/get","shop_id="+shopId,success,fail);},getMoreProductList:function(shopId,cateId,from,offset,success,fail){doGet("shop/getitems","shop_id="+shopId+"&category_id="+cateId+"&from="+from+"&offset="+offset,success,fail);},getMyOrders:function(shopId,from,offset,success,fail){doGet("order/list","shop_id="+shopId+"&from="+from+"&offset="+offset,success,fail);},orderHasbeenRead:function(shopId,order_id,success,fail){doGet("order/read","shop_id="+shopId+"&order_id="+order_id,success,fail);},getMoreMyOrders:function(shopId,from,offset,success,fail){doGet("order/list","shop_id="+shopId+"&from="+from+"&offset="+offset,success,fail);},getSearchResults:function(shopId,key,success,fail){doGet("shopItem/query","shop_id="+shopId+"&query="+key,success,fail);},getItemInfo:function(serialNo,success,fail){doGet("product/get","serialNo="+serialNo,success,fail);},deleteItem:function(itemId,shopId,success,fail){doGet("shopItem/del","itemId="+itemId+"&shop_id="+shopId,success,fail);},stickItem:function(itemId,categoryId,shopId,success,fail){doGet("shopItem/sticky","itemId="+itemId+"&category_id="+categoryId+"&shop_id="+shopId,success,fail);},addItem:function(options,success,fail){doPost("shopItem/addItem",options,success,fail);},updateItem:function(options,shopId,success,fail){options.shop_id=shopId;doPost("shopItem/update",options,success,fail);},uploadPicForItem:function(serialNo,fileURI,shopId,success,fail){var options=new FileUploadOptions();options.fileKey="pic";options.fileName=fileURI.substr(fileURI.lastIndexOf("/")+1);options.mimeType="image/jpeg";options.params={serialNo:serialNo,pic:fileURI,shop_id:shopId};var ft=new FileTransfer();ft.upload(fileURI,encodeURI(serverInfo.host+serverInfo.context+"shopItem/ul_pic"),success,fail,options);},getShopList:function(from,offset,success,fail){doGet("shop/shopList","from="+from+"&offset="+offset,success,fail);},updateShopInfo:function(options,success,fail){doPost("shop/updateShopInfo",options,success,fail);},getShopInfo:function(shop_id,success,fail){doGet("shop","shop_id="+shop_id,success,fail);},getNearShopList:function(lat,lng,success,fail){doGet("near","lat="+lat+"&lng="+lng,success,fail);},subscribeForCurrentDevice:function(ower_phone,chn,device_token,success,fail){doGet("subscribe","ower_phone="+ower_phone+"&chn="+chn+"&device_token="+device_token,success,fail);}};}]);angular.module("miaomiao.console.services").filter("getTotolCount",function(){return function(input){input=input||[];var total=0;for(var item_idx=0;item_idx<input.length;item_idx++){total+=parseInt(input[item_idx].count||0);}return total;};}).filter("getTotolPrice",function(){return function(input){input=input||[];var total=0;for(var item_idx=0;item_idx<input.length;item_idx++){total+=parseFloat(input[item_idx].price||0)*parseInt(input[item_idx].count||0);}return total/100;};}).filter("removeAMPM",function(){return function(text){if(!text){return;}return text.replace(/AM/,"").replace(/PM/,"");};}).filter("getShopStatusString",function(){return function(input){return input==0?"营业中":"打烊了";};}).filter("getShopMinPrice",function(){return function(input){return input?input/100:20;};}).filter("getDisplayShoppingPrice",function(){return function(input){return input?input/100:0;};}).filter("timeAgo",function(){var cache=[];return function(date){if(typeof cache[date]==="string"){return cache[date];}var prettyDate=moment(date,"X").fromNow();cache[date]=prettyDate;return prettyDate;};});angular.module("miaomiao.console.services").factory("MMUtils",["$timeout","$ionicLoading","$ionicPopup",function($timeout,$ionicLoading,$ionicPopup){return{isEmptyObject:function(obj){if(obj==null){return true;}if(obj.length>0){return false;}if(obj.length===0){return true;}for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){return false;}}return true;},isValidTelNumber:function(number){var regPhone=/^(([0\+]\d{2,3}-)?(0\d{2,3})-)?(\d{7,8})(-(\d{3,}))?$/;var regMobile=/^1[3|4|5|6|7|8|9][0-9]{1}[0-9]{8}$/;return regPhone.test(number)||regMobile.test(number);},showLoadingIndicator:function(message,scope,tmpUrl){scope.LoadingMessage=message;$ionicLoading.show({templateUrl:tmpUrl||"templates/loadingIndicator.html",scope:scope});},showAlert:function(message,tmpUrl){$ionicPopup.alert({title:message,template:tmpUrl||""});}};}]);angular.module("miaomiao.console.directives",[]).directive("backImg",function(){return function(scope,element,attrs){var url=attrs.backImg;element.css({"background-image":"url("+url+")","background-size":"contain"});};}).directive("ngTimeSelector",function(){return{restrict:"EA",templateUrl:"templates/timepicker.html",scope:{hours:"=",minutes:"="},replace:true,link:function(scope,elem,attr){scope.period="上午";scope.increaseHours=function(){if(scope.hours<23){scope.hours=++scope.hours;}else{scope.hours=0;}};scope.decreaseHours=function(){scope.hours=scope.hours<=0?23:--scope.hours;};scope.increaseMinutes=function(){if(scope.minutes>=59){scope.minutes=0;}else{scope.minutes++;}};scope.decreaseMinutes=function(){if(scope.minutes<=0){scope.minutes=59;}else{scope.minutes=--scope.minutes;}};scope.displayHours=function(){var hoursToDisplay=scope.hours;if(scope.hours>12){hoursToDisplay=scope.hours-12;}if(hoursToDisplay==0){hoursToDisplay=12;}else{if(hoursToDisplay<=9){hoursToDisplay="0"+hoursToDisplay;}}return hoursToDisplay;};scope.displayMinutes=function(){return scope.minutes<=9?"0"+scope.minutes:scope.minutes;};scope.switchPeriod=function(){scope.hours=scope.hours>=12?scope.hours-12:scope.hours+12;};}};});angular.module("miaomiao.console.controllers",[]).controller("MainCtrl",function($scope,$state,$window,$cordovaPush,$timeout,$cordovaDialogs,$cordovaMedia,$cordovaToast,ionPlatform,$http,httpClient,localStorageService,MMPushNotification){$scope.open=function(url){var params="location=no,enableViewportScale=yes,toolbarposition=top,closebuttoncaption=Done";var iab=window.open(url,"_blank",params);iab.addEventListener("exit",function(){iab.removeEventListener("exit",argument.callee);iab.close();iab=null;});};var halfHeight=null;$scope.getHalfHeight=function(){if(ionic.Platform.isAndroid()){return 0;}if(!halfHeight){halfHeight=(document.documentElement.clientHeight/2)-200;}return halfHeight;};$scope.notifications=[];$scope.registerToken=undefined;ionPlatform.ready.then(function(device){$scope.register();});var onNotification=$window.onNotification=window.onNotification=function onNotification(notification){console.log(JSON.stringify(notification));if(ionic.Platform.isAndroid()){handleAndroid(notification);}else{if(ionic.Platform.isIOS()){handleIOS(notification);$scope.$apply(function(){$scope.notifications.push(JSON.stringify(notification.alert));});}}};$scope.register=function(){var config={};if(ionic.Platform.isAndroid()){config={senderID:"miaomiao-bconsole",ecb:"onNotification"};}else{if(ionic.Platform.isIOS()){config={badge:"true",sound:"true",alert:"true",ecb:"onNotification"};}else{return;}}$cordovaPush.register(config).then(function(result){console.log("Register success "+result);$scope.registerDisabled=true;$scope.registerToken=result;if(result!=null){localStorageService.set("MMCONSOLE_META_PUSH_DEVICE_TOKEN",result);MMPushNotification.subscribe();}},function(err){console.log("Register error "+err);});};function handleAndroid(notification){console.log("handle Android : In foreground "+notification.foreground+" Coldstart "+notification.coldstart);if(notification.event=="registered"){$scope.regId=notification.regid;localStorageService.set("MMCONSOLE_META_PUSH_DEVICE_TOKEN",notification.regid);MMPushNotification.subscribe();}else{if(notification.event=="message"){var title="喵喵商家推送",text="您有新的订单，请到我的订单下查看";if(notification.payload&&notification.payload.body&&notification.payload.body.body){text=notification.payload.body.body.text;title=notification.payload.body.body.title;}$cordovaDialogs.alert(text,title).then(function(){$state.go("tab.order",null,{reload:true});$timeout(function(){MMPushNotification.newOrderNotificationReceived({count:1});},100);});$scope.$apply(function(){$scope.notifications.push(JSON.stringify(notification.message));});}else{if(notification.event=="error"){$cordovaDialogs.alert(notification.msg,"Push notification error event");}else{$cordovaDialogs.alert(notification.event,"Push notification handler - Unprocessed Event");}}}}function handleIOS(notification){console.log("handle iOS : In foreground "+notification.foreground+" Coldstart "+notification.coldstart);console.log("handle iOS: the notification is:"+JSON.stringify(notification));var inappHanlder=function(){$state.go("tab.order",null,{reload:true});$timeout(function(){MMPushNotification.newOrderNotificationReceived({count:1});},100);};if(notification.foreground=="1"){if(notification.body&&notification.messageFrom){console.log("the notification body is:"+notification.body);$cordovaDialogs.alert(notification.body,notification.messageFrom).then(function(){inappHanlder();});}else{console.log("the notification body alert:"+notification.alert);$cordovaDialogs.alert(notification.alert,"喵喵商家推送","确定").then(function(){inappHanlder();});}if(notification.badge){console.log("we are in foreground badge");$cordovaPush.setBadgeNumber(notification.badge).then(function(result){console.log("Set badge success "+result);},function(err){console.log("Set badge error "+err);});}if(notification.sound){console.log("we are in foreground and have sound");var mediaSrc=$cordovaMedia.newMedia(notification.sound);mediaSrc.promise.then($cordovaMedia.play(mediaSrc.media));}}else{console.log("we are in background");if(notification.body&&notification.messageFrom){console.log("we are in background body");$cordovaDialogs.alert(notification.body,notification.messageFrom).then(function(){inappHanlder();});}else{console.log("we are in background alert");$cordovaDialogs.alert(notification.alert,"喵喵商家推送").then(function(){inappHanlder();});}if(notification.badge){console.log("we are in background mode");$cordovaPush.setBadgeNumber(notification.badge).then(function(result){console.log("Set badge success "+result);},function(err){console.log("Set badge error "+err);});}}}$scope.unregister=function(){console.log("Unregister called");$scope.registerDisabled=false;$cordovaPush.unregister({}).then(function(result){console.log("Unregister success "+result);},function(err){console.log("Unregister error "+err);});};});angular.module("miaomiao.console.controllers").controller("SignInCtrl",function($scope,$ionicLoading,$compile,$ionicPopup,$timeout,$ionicScrollDelegate,$http,$state,localStorageService,httpClient,MMUtils,MMPushNotification){$scope.user=localStorageService.get("MMCONSOLE_METADATA_USER")||{};$scope.signIn=function(user){if(!$scope.user.password||!$scope.user.name){MMUtils.showAlert("请输入用户名和密码");return;}if(!MMUtils.isValidTelNumber($scope.user.phone)){MMUtils.showAlert("电话号码格式不正确");return;}MMUtils.showLoadingIndicator("正在登陆,请稍候...",$scope);httpClient.login($scope.user.phone,$scope.user.password,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("登陆失败:"+data.msg);return;}localStorageService.set("MMCONSOLE_METADATA_USER",{name:$scope.user.name,phone:$scope.user.phone,identity:$scope.user.phone,token:dataDetail.token});localStorageService.set("MMCONSOLE_METADATA_SHOP_LIST",dataDetail.shop);localStorageService.set("MMCONSOLE_METADATA_DEFAULT_SHOP",dataDetail.shop[0]);MMPushNotification.subscribe();$state.go("tab.front-page",null,{reload:true});},function(data,status){$ionicLoading.hide();MMUtils.showAlert("登陆失败");});};});angular.module("miaomiao.console.controllers").controller("ChangePwdCtrl",function($scope,$ionicLoading,$compile,$ionicPopup,$timeout,$ionicScrollDelegate,$http,$state,localStorageService,httpClient,MMUtils,MMPushNotification){$scope.user=localStorageService.get("MMCONSOLE_METADATA_USER")||{};$scope.changepwd=function(user){if(!$scope.user.old_password||!$scope.user.new_password||!$scope.user.new_password_confirm){MMUtils.showAlert("密码输入不能为空");return;}if($scope.user.old_password==$scope.user.new_password){MMUtils.showAlert("新密码不能与旧密码相同");return;}if($scope.user.new_password!=$scope.user.new_password_confirm){MMUtils.showAlert("新密码两次输入不一致");return;}MMUtils.showLoadingIndicator("正在修改密码,请稍候...",$scope);httpClient.changePwd($scope.user.phone,$scope.user.old_password,$scope.user.new_password,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("修改密码失败:"+data.msg);return;}$state.go("signin",null,{reload:true});},function(data,status){$ionicLoading.hide();MMUtils.showAlert("修改密码失败");});};});angular.module("miaomiao.console.controllers").controller("FrontPageCtrl",function($scope,$ionicLoading,$ionicActionSheet,$ionicPopup,$state,$timeout,localStorageService,$ionicScrollDelegate,httpClient,MMShopService,MMUtils){$scope.info={};$scope.info.shop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP")||{};$scope.shopName=$scope.info.shop.name||"首页";$scope.getSummaryInfo=function(success,fail){httpClient.getSummary($scope.info.shop.id,"","",function(data,status){var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("加载数据失败:"+data.msg);return fail();}success(dataDetail);},function(data,status){fail();});};$timeout(function(){$scope.info.summary={};$ionicScrollDelegate.resize();MMUtils.showLoadingIndicator("正在加载,请稍候...",$scope);$scope.getSummaryInfo(function(dataDetail){$ionicLoading.hide();$scope.info.summary=dataDetail;},function(){$ionicLoading.hide();});});$scope.$on("$ionicView.afterEnter",function(){});$scope.doRefresh=function(){$scope.shopName=$scope.info.shop.name||"首页";$scope.getSummaryInfo(function(dataDetail){$ionicLoading.hide();$scope.$broadcast("scroll.refreshComplete");$scope.info.summary=dataDetail;},function(){$ionicLoading.hide();$scope.$broadcast("scroll.refreshComplete");});};$scope.doShopInfoRefresh=function(){$timeout(function(){$scope.info.shop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP")||{};$scope.shopName=$scope.info.shop.name||"首页";MMShopService.switchDefaultShopNotification({});});};$scope.showUserAction=function(){$ionicActionSheet.show({buttons:[{text:"更改密码"}],destructiveText:"退出登陆",cancelText:"取消",cancel:function(){},buttonClicked:function(index){if(index==0){$state.go("changepassword",null,{reload:true});}return true;},destructiveButtonClicked:function(){$scope.user=localStorageService.get("MMCONSOLE_METADATA_USER");httpClient.logOut($scope.user.phone,function(data,status){localStorageService.set("MMCONSOLE_METADATA_USER",{name:$scope.user.name,phone:$scope.user.phone});$state.go("signin",null,{reload:true});},function(data,status){$state.go("signin",null,{reload:true});});return true;}});};MMShopService.onSwitchDefaultShopNotification($scope,function(){$timeout(function(){$scope.info.shop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP")||{};$scope.doRefresh();});});});angular.module("miaomiao.console.controllers").controller("OrderCtrl",function($scope,$rootScope,$ionicModal,$ionicPopup,$ionicLoading,$state,$timeout,$ionicScrollDelegate,httpClient,localStorageService,MMPushNotification,MMShopService,MMUtils){$scope.info={};$scope.info.orders=[];$scope.info.notification_order_count=1;$scope.info.shop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP")||{};function transformOrderData(orders){if(!orders){return;}for(var i=0;i<orders.length;i++){var order=orders[i];try{order.items=JSON.parse(order.info);}catch(e){}}}var canLoadMore=false;$scope.moreOrderCanBeLoaded=function(){return canLoadMore;};$scope.getOrdersInfo=function(from,offset,success,fail){httpClient.getMyOrders($scope.info.shop.id,from,offset,function(data,status){var code=data.code,dataDetail=data.data;if(!code==0){MMUtils.showAlert("加载数据失败");canLoadMore=false;return fail();}canLoadMore=false;if(dataDetail.orderls&&dataDetail.orderls.length>0){canLoadMore=true;}success(dataDetail);},function(data,status){MMUtils.showAlert("加载数据失败");canLoadMore=false;return fail();});};function initData(){var from=0,offset=20;MMUtils.showLoadingIndicator("正在加载,请稍候...",$scope);$scope.getOrdersInfo(from,offset,function(dataDetail){$ionicLoading.hide();$scope.info.orders=dataDetail.orderls;transformOrderData($scope.info.orders);},function(){$ionicLoading.hide();});}initData();$scope.addOrders=function(){if(!$scope.info.orders.length){return;}var from=$scope.info.orders.length,offset=20;$scope.getOrdersInfo(from,offset,function(dataDetail){$scope.info.orders=$scope.info.orders.concat(dataDetail.orderls);transformOrderData($scope.info.orders);$scope.$broadcast("scroll.infiniteScrollComplete");},function(){$scope.$broadcast("scroll.infiniteScrollComplete");});};$scope.doRefresh=function(){var from=0,offset=20;$scope.getOrdersInfo(from,offset,function(dataDetail){$scope.$broadcast("scroll.refreshComplete");transformOrderData(dataDetail.orderls);for(var i=0;i<dataDetail.orderls.length;i++){for(var j=0;j<$scope.info.orders.length;j++){if(dataDetail.orderls[i].order_id==$scope.info.orders[j].order_id){dataDetail.orderls[i].read=$scope.info.orders[j].read;}}}$scope.info.orders=dataDetail.orderls;$rootScope.$broadcast("orderScroll.refreshComplete");},function(){$scope.$broadcast("scroll.refreshComplete");$rootScope.$broadcast("orderScroll.refreshComplete");});};$ionicModal.fromTemplateUrl("templates/order-detail.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal;});$scope.openModal=function(){$scope.modal.show();};$scope.closeModal=function(){$scope.modal.remove();};$scope.$on("$destroy",function(){$scope.modal.remove();});$scope.$on("modal.hide",function(){});$scope.$on("modal.removed",function(){});$scope.$on("modal.shown",function(){});$scope.callNumber=function(number){window.plugins.CallNumber.callNumber(function(){},function(){},number);};$scope.showOrderDetail=function(order){$scope.order=order;$ionicModal.fromTemplateUrl("templates/order-detail.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal;$scope.openModal();});if($scope.order.readed==false){httpClient.orderHasbeenRead($scope.info.shop.id,order.order_id,function(data,status){$scope.order.readed=true;},function(data,status){});}};$scope.$on("$ionicView.afterEnter",function(){});MMShopService.onSwitchDefaultShopNotification($scope,function(){$scope.info.shop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP")||{};initData();});}).controller("orderTabCtrl",function($scope,$timeout,MMPushNotification,$cordovaPush){$scope.info={};$scope.info.notification_order_count=0;MMPushNotification.onNewOrderNotificationReceived($scope,function(message){console.log(message);var data=message.data;$timeout(function(){var count=data&&data.count||0;$scope.info.notification_order_count+=count;});});$scope.$on("orderScroll.refreshComplete",function(){$scope.info.notification_order_count=0;$cordovaPush.setBadgeNumber(0).then(function(result){console.log("Set badge success "+result);},function(err){console.log("Set badge error "+err);});});});angular.module("miaomiao.console.controllers").controller("ProductListCtrl",function($scope,$ionicPopup,$ionicLoading,$ionicModal,$state,$timeout,$ionicScrollDelegate,localStorageService,httpClient,MMShopService,Camera,MMProductService,MMUtils){$scope.info=$scope.info||{};$scope.info.shop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP")||{};var hasData=false;MMProductService.onSwitchCategoryNotification($scope,function(message){var data=message.data;$scope.selectedIndex=data.index;$scope.category=MMProductService.getCategoryForIndex($scope.selectedIndex);hasData=true;$timeout(function(){$scope.items=$scope.category.itemls;$timeout(function(){$ionicScrollDelegate.resize();$ionicScrollDelegate.$getByHandle("productScroll").scrollTop();},500);});});MMProductService.onRenderDataNotification($scope,function(message){var data=message.data;$timeout(function(){$scope.items=data;$ionicScrollDelegate.resize();});});$scope.moreDataCanBeLoaded=function(){if(!hasData){return false;}return $scope.category&&$scope.category.canLoadMore;};$scope.addItems=function(idx){var idx=$scope.selectedIndex,cateId=$scope.category.category_id,from=$scope.category.scrollIndex,offset=20;MMProductService.setInLoadingMoreFlag(true);httpClient.getMoreProductList($scope.info.shop.id,cateId,from,offset,function(data,status){var code=data.code,dataDetail=data.data;if(!code==0||dataDetail.itemls.length==0){MMProductService.setInLoadingMoreFlag(false);MMProductService.setCanLoadMoreFlagForIndex(idx,false);$scope.$broadcast("scroll.infiniteScrollComplete");$ionicScrollDelegate.$getByHandle("productScroll").resize();return;}MMProductService.setInLoadingMoreFlag(false);MMProductService.addMoreItemsForCategoryId(cateId,dataDetail.itemls);$scope.category=MMProductService.getCategoryForIndex(idx);$timeout(function(){$scope.items=$scope.category.itemls;$scope.$broadcast("scroll.infiniteScrollComplete");$ionicScrollDelegate.resize();});},function(data,status){MMProductService.setInLoadingMoreFlag(false);MMProductService.setCanLoadMoreFlagForIndex(idx,false);$scope.$broadcast("scroll.infiniteScrollComplete");});};$scope.deleteItemFromCurrentCategory=function(item){var currentCategory=$scope.category;if(!currentCategory){return;}var index=currentCategory.itemls.indexOf(item);if(index>-1){$timeout(function(){currentCategory.itemls.splice(index,1);MMProductService.setCategoryForIndex($scope.selectedIndex,currentCategory);});}};$scope.stickItemFromCurrentCategory=function(item){var currentCategory=$scope.category;if(!currentCategory){return;}var index=currentCategory.itemls.indexOf(item);if(index!=-1){$timeout(function(){currentCategory.itemls.splice(index,1);currentCategory.itemls.unshift(item);MMProductService.setCategoryForIndex($scope.selectedIndex,currentCategory);});}};$scope.updateItemFromCurrentCategory=function(item){var currentCategory=$scope.category;if(!currentCategory){return;}var index=currentCategory.itemls.indexOf(item);if(index!=-1){$timeout(function(){if(item.new_pic_url&&item.new_pic_url!=item.pic_url){item.pic_url=item.new_pic_url;}currentCategory.itemls.splice(index,1,item);MMProductService.setCategoryForIndex($scope.selectedIndex,currentCategory);});}};$scope.cancelEdit=function($event){if(window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard){cordova.plugins.Keyboard.close();}$scope.closeModal();};$scope.inputReadyKeyup=function($event){if($event.keyCode==13){$event.target.blur();}};$scope.info.editingItem={};$ionicModal.fromTemplateUrl("templates/product-edit.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal;});$scope.openModal=function(){$scope.modal.show();};$scope.closeModal=function($event){$scope.modal.remove();$timeout(function(){closeKeyboard();});};$scope.$on("$destroy",function(){$scope.modal.remove();});$scope.$on("modal.hide",function(){$scope.refreshCurrentCategory();});$scope.EditItem=function(item){$scope.editingItem=item;$scope.editingItem.hasNewPicture=false;$ionicModal.fromTemplateUrl("templates/product-edit.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal;$scope.openModal();});};$scope.StickItem=function(item){MMUtils.showLoadingIndicator("正在置顶,请稍候...",$scope);httpClient.stickItem(item.id,item.category_id,$scope.info.shop.id,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("置顶商品失败:"+data.msg);return;}$scope.closeModal();$scope.stickItemFromCurrentCategory(item);},function(data,status){$ionicLoading.hide();MMUtils.showAlert("置顶商品失败");$scope.closeModal();});};function closeKeyboard(){if(window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard){cordova.plugins.Keyboard.close();}}function _saveItemInfo(options,item){MMUtils.showLoadingIndicator("正在保存,请稍候...",$scope);httpClient.updateItem(options,$scope.info.shop.id,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("修改商品失败:"+data.msg);return;}$scope.closeModal();$scope.updateItemFromCurrentCategory(item);},function(data,status){$ionicLoading.hide();MMUtils.showAlert("修改商品失败");});}$scope.saveItem=function(item,$event){if($event){$event.target.parentElement.focus();}item.price=item.updated_price*100;item.name=item.updated_name;var options={itemName:item.name,itemId:item.id,serialNo:item.serialNo,category_id:item.category_id,count:item.count,score:item.score,price:item.price,saleStatus:item.onsell};if(item.hasNewPicture){MMUtils.showLoadingIndicator("正在上传图片,请稍候...",$scope);httpClient.uploadPicForItem(item.serialNo,item.new_pic_url,$scope.info.shop.id,function(data,status){$ionicLoading.hide();console.log("upload pic success:"+JSON.stringify(data));if(!data||!data.response){MMUtils.showAlert("上传图片失败:"+JSON.stringify(data));return;}console.log("upload pic success :"+JSON.stringify(data.response));if(typeof(data.response)=="string"){data.response=eval("("+data.response+")");}var code=data.response.code,dataDetail=data.response.data;console.log("upload pic success code is:"+code+" ,data :"+JSON.stringify(dataDetail));if(parseInt(code)!=0){MMUtils.showAlert("上传图片失败:"+data.response.msg);return;}options.pic_url=dataDetail.url;_saveItemInfo(options,item);},function(data,status){$ionicLoading.hide();MMUtils.showAlert("上传图片失败,请重试");});}else{_saveItemInfo(options,item);}};$scope.deleteItem=function(item){var confirmPopup=$ionicPopup.confirm({title:"删除商品",template:"确定要删除此商品？"});confirmPopup.then(function(res){if(res){MMUtils.showLoadingIndicator("正在删除,请稍候...",$scope);httpClient.deleteItem(item.id,$scope.info.shop.id,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("删除失败:"+data.msg);return;}$scope.closeModal();$scope.deleteItemFromCurrentCategory(item);},function(data,status){$ionicLoading.hide();MMUtils.showAlert("删除失败");$scope.closeModal();});}});};function clearCache(){navigator.camera.cleanup();}function onCapturePhoto(fileURI){$scope.editingItem.new_pic_url=fileURI;$scope.editingItem.hasNewPicture=true;}$scope.getPhoto=function(item,$event){$event.stopPropagation();Camera.getPicture().then(onCapturePhoto,function(err){console.err(err);},{quality:25,targetWidth:320,targetHeight:320,destinationType:navigator.camera.DestinationType.FILE_URI,saveToPhotoAlbum:false});};});angular.module("miaomiao.console.controllers").controller("ProductCtrl",function($scope,$ionicPopup,$ionicLoading,$ionicModal,$state,$timeout,$ionicScrollDelegate,localStorageService,httpClient,MMShopService,Camera,MMProductService,MMUtils){$scope.info={};$scope.pageName="商品";$scope.info.shop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP")||{};function initData(){MMUtils.showLoadingIndicator("正在加载,请稍候...",$scope);httpClient.getProductList($scope.info.shop.id,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(!code==0){MMUtils.showAlert("加载数据失败");return;}MMProductService.initCategorysWithData(dataDetail.categoryls);$scope.info.categorySummary=MMProductService.getCategorySummary();var initIndex=0;$scope.selectedIndex=initIndex;$scope.selectCategory(initIndex);},function(data,status){$ionicLoading.hide();MMUtils.showAlert("加载数据失败");});}initData();$scope.refreshAll=function(){initData();};$scope.selectCategory=function($index,timeout){if(MMProductService.getInLoadingMoreFlag()==true){return;}$scope.selectedIndex=$index;$timeout(function(){MMProductService.switchCategoryNotification({index:$scope.selectedIndex});},timeout||100);};$scope.refreshCurrentCategory=function(){$scope.selectCategory($scope.selectedIndex);};$scope.addProductForCategory=function(cateId,item){$timeout(function(){MMProductService.addProductItemToCategory(cateId,item);for(var idx=0;idx<$scope.info.categorySummary.length;idx++){if(cateId==$scope.info.categorySummary[idx].category_id){$scope.selectCategory(idx);break;}}});};MMShopService.onSwitchDefaultShopNotification($scope,function(){$scope.info.shop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP")||{};initData();});});angular.module("miaomiao.console.controllers").controller("ShopListCtrl",["$scope","$state","$filter","$ionicPopup","$ionicModal","localStorageService","$ionicLoading","httpClient","$ionicScrollDelegate","$timeout",function($scope,$state,$filter,$ionicPopup,$ionicModal,localStorageService,$ionicLoading,httpClient,$ionicScrollDelegate,$timeout){$ionicModal.fromTemplateUrl("templates/shop-list.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal;});$scope.info={};$scope.info.shoplist=localStorageService.get("MMCONSOLE_METADATA_SHOP_LIST")||[];$scope.info.defaultShop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP")||($scope.info.shoplist&&$scope.info.shoplist[0]);$scope.info.shopName=$scope.info.defaultShop.name||"首页";$scope.openModal=function(){$scope.modal.show();};$scope.closeModal=function(){$scope.modal.hide();};$scope.$on("$destroy",function(){$scope.modal.remove();});$scope.$on("modal.hide",function(){});$scope.$on("modal.removed",function(){});$scope.$on("modal.shown",function(){});$scope.switchDefaultShop=function(shopInfo,$event){$event.stopPropagation();if(shopInfo.id==$scope.info.defaultShop.id){$scope.closeModal();return;}$scope.info.defaultShop=shopInfo;localStorageService.set("MMCONSOLE_METADATA_DEFAULT_SHOP",shopInfo);$scope.closeModal();$scope.doShopInfoRefresh();};$scope.ShowShopList=function(){$timeout(function(){$scope.info.shoplist=localStorageService.get("MMCONSOLE_METADATA_SHOP_LIST")||[];$scope.info.defaultShop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP");$scope.openModal();});};}]);angular.module("miaomiao.console.controllers").controller("EditShopCtrl",["$scope","$state","$filter","$ionicPopup","$ionicModal","localStorageService","$ionicLoading","httpClient","$ionicScrollDelegate","$timeout","MMShopService","MMUtils",function($scope,$state,$filter,$ionicPopup,$ionicModal,localStorageService,$ionicLoading,httpClient,$ionicScrollDelegate,$timeout,MMShopService,MMUtils){$scope.editingShop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP");function _reformatHourMinutes(number){return(parseInt(number)<10?"0":"")+number;}function initData(){$scope.editingShop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP");$scope.allHours=[];for(var i=1;i<=24;i++){$scope.allHours.push(i);}$scope.allMinutes=[];for(var i=0;i<60;i++){$scope.allMinutes.push(_reformatHourMinutes(i));}$scope.editingShop.new_base_price=$scope.editingShop.base_price/100;if(!$scope.editingShop.open_time&&!$scope.editingShop.close_time){$scope.editingShop.isFullTimeOpen=true;$scope.editingShop.new_open_time={hours:8,minutes:_reformatHourMinutes(0)};$scope.editingShop.new_close_time={hours:22,minutes:_reformatHourMinutes(0)};}else{var date=new Date($scope.editingShop.open_time);$scope.editingShop.new_open_time={hours:date.getHours(),minutes:_reformatHourMinutes(date.getMinutes())};date=new Date($scope.editingShop.close_time);$scope.editingShop.new_close_time={hours:date.getHours(),minutes:_reformatHourMinutes(date.getMinutes())};}}$scope.cancelEditShop=function(item){$state.go("tab.front-page",null,{reload:false});};$scope.saveShop=function(item){var options={shop_id:$scope.editingShop.id,name:$scope.editingShop.name,tel:$scope.editingShop.tel,shop_address:$scope.editingShop.shop_address,owner_phone:$scope.editingShop.owner_phone,base_price:$scope.editingShop.new_base_price*100,shopInfo:$scope.editingShop.shop_info,status:$scope.editingShop.status};if(item.isFullTimeOpen){options.open_time=null;options.close_time=null;}else{if(item.new_open_time){options.open_time=item.new_open_time.hours+":"+item.new_open_time.minutes;}if(item.new_close_time){options.close_time=item.new_close_time.hours+":"+item.new_close_time.minutes;}}MMUtils.showLoadingIndicator("正在保存,请稍候...",$scope);httpClient.updateShopInfo(options,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("修改店铺失败:"+data.msg);return;}$timeout(function(){$ionicScrollDelegate.resize();$ionicScrollDelegate.scrollTop();localStorageService.set("MMCONSOLE_METADATA_DEFAULT_SHOP",dataDetail.shop);var shopList=localStorageService.get("MMCONSOLE_METADATA_SHOP_LIST")||[];for(var i=0;i<shopList.length;i++){if(shopList[i].id==dataDetail.shop.id){shopList[i]=dataDetail.shop;}}localStorageService.set("MMCONSOLE_METADATA_SHOP_LIST",shopList);$state.go("tab.front-page",null,{reload:true});MMShopService.switchDefaultShopNotification({});});},function(data,status){$ionicLoading.hide();MMUtils.showAlert("修改店铺失败");});};$scope.hasTimePickerPlugin=function(){return typeof(datePicker)=="undefined"?false:true;};$scope.showTimePicker=function(item,action){if(action=="open"){var options={date:item.open_time?new Date(item.open_time):new Date(),mode:"time"};datePicker.show(options,function(date){if(!date){return;}var res=new Date(date);$timeout(function(){item.new_open_time={hours:res.getHours(),minutes:_reformatHourMinutes(res.getMinutes())};console.log("get new open time:"+item.new_open_time.hours+":"+item.new_open_time.minutes);});});}else{if(action=="close"){var options={date:item.close_time?new Date(item.close_time):new Date(),mode:"time"};datePicker.show(options,function(date){if(!date){return;}var res=new Date(date);$timeout(function(){item.new_close_time={hours:res.getHours(),minutes:_reformatHourMinutes(res.getMinutes())};console.log("get new close time:"+item.new_close_time.hours+":"+item.new_close_time.minutes);});});}}};$scope.updateShopFullTimeOpen=function(){$timeout(function(){$ionicScrollDelegate.resize();});};$scope.$on("$ionicView.afterEnter",function(){$timeout(function(){initData();});});}]);angular.module("miaomiao.console.controllers").controller("AddProductCtrl",["$scope","$ionicPopup","$ionicModal","httpClient","localStorageService","$timeout","$ionicLoading","Camera","MMUtils",function($scope,$ionicPopup,$ionicModal,httpClient,localStorageService,$timeout,$ionicLoading,Camera,MMUtils){$scope.info.shop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP")||[];$scope.hasProductInfo=false;$scope.findItem=function(serialNo,$event){if($event){$event.target.blur();}if(!serialNo){MMUtils.showAlert("请输入条形码");return;}MMUtils.showLoadingIndicator("正在查找商品信息,请稍候...",$scope);httpClient.getItemInfo(serialNo,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("查找商品失败,请手动添加:"+data.msg);}$scope.hasProductInfo=true;var item=dataDetail.product;$timeout(function(){$scope.newitem=item;$scope.newitem.currentCateId=item.category_id;$scope.newitem.saleStatus=1;});},function(data,status){$ionicLoading.hide();$scope.hasProductInfo=true;MMUtils.showAlert("查找商品失败,请手动添加");});};$scope.newitem={};$scope.openQRScaner=function(){cordova.plugins.barcodeScanner.scan(function(result){$timeout(function(){$scope.newitem.serialNo=result.text;$scope.findItem($scope.newitem.serialNo);});},function(error){MMUtils.showAlert("查找商品失败,请手动添加");});};$scope.inputReadyKeyup=function($event){if($event.keyCode==13){$event.target.blur();}};$scope.AddItem=function(){$scope.newitem={};$scope.hasProductInfo=false;$scope.openModal();};$scope.saveItem=function(newitem){if(!newitem.currentCateId){MMUtils.showAlert("请选择商品分类");return;}if(!newitem.name){MMUtils.showAlert("请填写商品名称");return;}if(!newitem.price){MMUtils.showAlert("请填写商品价格");return;}var options={serialNo:newitem.serialNo,name:newitem.name,categoryId:newitem.currentCateId,count:newitem.count,score:newitem.score,price:newitem.price*100,saleStatus:newitem.saleStatus,shop_id:$scope.info.shop.id};function addItemInfo(options,newitem){MMUtils.showLoadingIndicator("正在添加,请稍候...",$scope);httpClient.addItem(options,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(code!=0){MMUtils.showAlert("添加商品失败:"+data.msg);return;}var item=dataDetail.item;$scope.closeModal();$scope.addProductForCategory(newitem.currentCateId,item);},function(data,status){$ionicLoading.hide();MMUtils.showAlert("添加商品失败");$scope.closeModal();});}if(newitem.hasNewPicture){MMUtils.showLoadingIndicator("正在上传图片,请稍候...",$scope);httpClient.uploadPicForItem(newitem.serialNo,newitem.new_pic_url,$scope.info.shop.id,function(data,status){$ionicLoading.hide();console.log("upload pic success:"+JSON.stringify(data));if(!data||!data.response){MMUtils.showAlert("上传图片失败:"+JSON.stringify(data));return;}if(typeof(data.response)=="string"){data.response=eval("("+data.response+")");}var code=data.response.code,dataDetail=data.response.data;console.log("upload pic success code is:"+code+" ,data :"+JSON.stringify(dataDetail));if(parseInt(code)!=0){MMUtils.showAlert("上传图片失败:"+data.response.msg);return;}options.pic_url=dataDetail.url;addItemInfo(options,newitem);},function(){$ionicLoading.hide();MMUtils.showAlert("上传图片失败,请重试");});}else{addItemInfo(options,newitem);}};$ionicModal.fromTemplateUrl("templates/product-addnew.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal;});$scope.openModal=function(){$scope.modal.show();};$scope.closeModal=function(){$scope.modal.hide();};$scope.$on("$destroy",function(){$scope.modal.remove();});$scope.$on("modal.hide",function(){});$scope.$on("modal.removed",function(){});$scope.$on("modal.shown",function(){});function clearCache(){navigator.camera.cleanup();}function onCapturePhoto(fileURI){$scope.newitem.new_pic_url=fileURI;$scope.newitem.hasNewPicture=true;}$scope.getPhoto=function(){Camera.getPicture().then(onCapturePhoto,function(err){console.err(err);},{quality:25,targetWidth:320,destinationType:navigator.camera.DestinationType.FILE_URI,saveToPhotoAlbum:false});};}]);angular.module("miaomiao.console.controllers").controller("SearchCtrl",function($scope,$ionicLoading,$state,$timeout,httpClient,localStorageService,MMUtils,MMProductService){$scope.pageName="搜索商品";$scope.focused="centered";$scope.searchTerm="";$scope.info={};$scope.info.hasNoResults=false;$scope.info.shop=localStorageService.get("MMCONSOLE_METADATA_DEFAULT_SHOP")||{};$scope.performSearch=function(key,$event){$event.target.blur();var KEY=key||$scope.info.key;MMUtils.showLoadingIndicator("正在搜索...",$scope);httpClient.getSearchResults($scope.info.shop.id,KEY,function(data,status){$ionicLoading.hide();var code=data.code,dataDetail=data.data;if(!code==0||dataDetail.itemls.length==0){$scope.info.searchResultsItems=[];$scope.info.hasNoResults=true;MMProductService.renderDataNotification($scope.info.searchResultsItems);return;}$scope.info.hasNoResults=false;$scope.info.searchResultsItems=dataDetail.itemls;MMProductService.renderDataNotification($scope.info.searchResultsItems);},function(data,status){$ionicLoading.hide();$scope.info.hasNoResults=true;});};$scope.clearSearch=function(){$scope.info.key="";};});