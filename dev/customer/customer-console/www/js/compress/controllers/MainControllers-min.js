angular.module("miaomiao.console.controllers",[]).controller("MainCtrl",function($scope,$state,$window,$cordovaPush,$timeout,$cordovaDialogs,$cordovaMedia,$cordovaToast,ionPlatform,$http,httpClient,localStorageService,MMPushNotification){$scope.open=function(url){var params="location=no,enableViewportScale=yes,toolbarposition=top,closebuttoncaption=Done";var iab=window.open(url,"_blank",params);iab.addEventListener("exit",function(){iab.removeEventListener("exit",argument.callee);iab.close();iab=null;});};var halfHeight=null;$scope.getHalfHeight=function(){if(ionic.Platform.isAndroid()){return 0;}if(!halfHeight){halfHeight=(document.documentElement.clientHeight/2)-200;}return halfHeight;};$scope.notifications=[];$scope.registerToken=undefined;ionPlatform.ready.then(function(device){$scope.register();});var onNotification=$window.onNotification=window.onNotification=function onNotification(notification){console.log(JSON.stringify(notification));if(ionic.Platform.isAndroid()){handleAndroid(notification);}else{if(ionic.Platform.isIOS()){handleIOS(notification);$scope.$apply(function(){$scope.notifications.push(JSON.stringify(notification.alert));});}}};$scope.register=function(){var config={};if(ionic.Platform.isAndroid()){config={senderID:"miaomiao-bconsole",ecb:"onNotification"};}else{if(ionic.Platform.isIOS()){config={badge:"true",sound:"true",alert:"true",ecb:"onNotification"};}else{return;}}$cordovaPush.register(config).then(function(result){console.log("Register success "+result);$scope.registerDisabled=true;$scope.registerToken=result;if(result!=null){localStorageService.set("MMCONSOLE_META_PUSH_DEVICE_TOKEN",result);MMPushNotification.subscribe();}},function(err){console.log("Register error "+err);});};function handleAndroid(notification){console.log("handle Android : In foreground "+notification.foreground+" Coldstart "+notification.coldstart);if(notification.event=="registered"){$scope.regId=notification.regid;localStorageService.set("MMCONSOLE_META_PUSH_DEVICE_TOKEN",notification.regid);MMPushNotification.subscribe();}else{if(notification.event=="message"){var title="喵喵商家推送",text="您有新的订单，请到我的订单下查看";$window.alert("android get notif:"+JSON.stringify(notification));if(notification.payload&&notification.payload.body&&notification.payload.body.body){text=notification.payload.body.body.text;title=notification.payload.body.body.title;}$cordovaDialogs.alert(text,title).then(function(){$state.go("tab.order",null,{reload:true});var setNewOrderStatus=function(){$timeout(function(){MMPushNotification.newOrderNotificationReceived({count:1});},100);};var setRemindOrderStatus=function(order_id){$timeout(function(){MMPushNotification.remindOrderNotificationReceived({orderId:order_id});},100);};if(notification.payload&&notification.payload.body&&notification.payload.body.extra){if(notification.payload.body.extra.type=="remind_order"){setRemindOrderStatus(notification.payload.body.extra.data.order_id);}else{if(notification.payload.body.extra.type=="cancel_order"){}else{if(notification.payload.body.extra.type=="confirm_order"){}else{setNewOrderStatus();}}}}else{setNewOrderStatus();}});$scope.$apply(function(){$scope.notifications.push(JSON.stringify(notification.message));});}else{if(notification.event=="error"){$cordovaDialogs.alert(notification.msg,"Push notification error event");}else{$cordovaDialogs.alert(notification.event,"Push notification handler - Unprocessed Event");}}}}function handleIOS(notification){console.log("handle iOS : In foreground "+notification.foreground+" Coldstart "+notification.coldstart);console.log("handle iOS: the notification is:"+JSON.stringify(notification));var inappHanlder=function(){$state.go("tab.order",null,{reload:true});var setNewOrderStatus=function(){$timeout(function(){MMPushNotification.newOrderNotificationReceived({count:1});},100);};var setRemindOrderStatus=function(order_id){$timeout(function(){MMPushNotification.remindOrderNotificationReceived({orderId:order_id});},100);};if(notification.type){if(notification.type=="remind_order"){setRemindOrderStatus(notification.data.order_id);}else{if(notification.type=="cancel_order"){}else{if(notification.type=="confirm_order"){}else{setNewOrderStatus();}}}}else{setNewOrderStatus();}};if(notification.foreground=="1"){if(notification.body&&notification.messageFrom){console.log("the notification body is:"+notification.body);$cordovaDialogs.alert(notification.body,notification.messageFrom).then(function(){inappHanlder();});}else{console.log("the notification body alert:"+notification.alert);$cordovaDialogs.alert(notification.alert,"喵喵商家推送","确定").then(function(){inappHanlder();});}if(notification.badge){console.log("we are in foreground badge");$cordovaPush.setBadgeNumber(notification.badge).then(function(result){console.log("Set badge success "+result);},function(err){console.log("Set badge error "+err);});}if(notification.sound){console.log("we are in foreground and have sound");var mediaSrc=$cordovaMedia.newMedia(notification.sound);mediaSrc.promise.then($cordovaMedia.play(mediaSrc.media));}}else{console.log("we are in background");if(notification.body&&notification.messageFrom){console.log("we are in background body");$cordovaDialogs.alert(notification.body,notification.messageFrom).then(function(){inappHanlder();});}else{console.log("we are in background alert");$cordovaDialogs.alert(notification.alert,"喵喵商家推送").then(function(){inappHanlder();});}if(notification.badge){console.log("we are in background mode");$cordovaPush.setBadgeNumber(notification.badge).then(function(result){console.log("Set badge success "+result);},function(err){console.log("Set badge error "+err);});}}}$scope.unregister=function(){console.log("Unregister called");$scope.registerDisabled=false;$cordovaPush.unregister({}).then(function(result){console.log("Unregister success "+result);},function(err){console.log("Unregister error "+err);});};});